<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>android创建信任所有证书的websocket ssl(wss)客户端 · NINE的博客</title><meta name="description" content="代码修改自:https://github.com/codebutler/android-websockets
HybiParser.java
//// HybiParser.java: draft-ietf-hybi-thewebsocketprotocol-13 parser//// Based "><meta name="keywords" content="NINE的博客,记录与分享计算机技术"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">NINE的博客</a></h3><div class="description"><p>NINE的博客。<br> 记录与分享计算机技术。</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/xuncv"><i class="fa fa-github"></i></a></li><li><a href="mailto:xuncv1@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/ljtnine/"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div><div class="beian"><a href="http://www.beian.miit.gov.cn/" target="_blank"></a><span style="height:10px;margin-left: 10px;">|</span><img src="https://qn.jixian.io/gongan.png" style="height:10px;margin-left: 10px;position: relative;top: 1px;"><span style="margin-left: 2px;"></span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>android创建信任所有证书的websocket ssl(wss)客户端</a></h3></div><div class="post-content"><p>代码修改自:<a target="_blank" rel="noopener" href="https://github.com/codebutler/android-websockets">https://github.com/codebutler/android-websockets</a></p>
<p>HybiParser.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// HybiParser.java: draft-ietf-hybi-thewebsocketprotocol-13 parser</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Based on code from the faye project.</span></span><br><span class="line"><span class="comment">// https://github.com/faye/faye-websocket-node</span></span><br><span class="line"><span class="comment">// Copyright (c) 2009-2012 James Coglan</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Ported from Javascript to Java by Eric Butler &lt;eric@codebutler.com&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// (The MIT License)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Permission is hereby granted, free of charge, to any person obtaining</span></span><br><span class="line"><span class="comment">// a copy of this software and associated documentation files (the</span></span><br><span class="line"><span class="comment">// &quot;Software&quot;), to deal in the Software without restriction, including</span></span><br><span class="line"><span class="comment">// without limitation the rights to use, copy, modify, merge, publish,</span></span><br><span class="line"><span class="comment">// distribute, sublicense, and/or sell copies of the Software, and to</span></span><br><span class="line"><span class="comment">// permit persons to whom the Software is furnished to do so, subject to</span></span><br><span class="line"><span class="comment">// the following conditions:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The above copyright notice and this permission notice shall be</span></span><br><span class="line"><span class="comment">// included in all copies or substantial portions of the Software.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span></span><br><span class="line"><span class="comment">// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span></span><br><span class="line"><span class="comment">// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE</span></span><br><span class="line"><span class="comment">// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION</span></span><br><span class="line"><span class="comment">// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION</span></span><br><span class="line"><span class="comment">// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.codebutler.android_websockets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybiParser</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;HybiParser&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WebSocketClient mClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mMasking = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>     mStage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mFinal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mMasked;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>     mOpcode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>     mLengthSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>     mLength;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>     mMode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] mMask    = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] mPayload = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mClosed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ByteArrayOutputStream mBuffer = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BYTE   = <span class="number">255</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIN    = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MASK   = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RSV1   =  <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RSV2   =  <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RSV3   =  <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OPCODE =  <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LENGTH = <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_TEXT   = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_BINARY = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_CONTINUATION =  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_TEXT         =  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_BINARY       =  <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_CLOSE        =  <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_PING         =  <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_PONG         = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Integer&gt; OPCODES = Arrays.asList(</span><br><span class="line">        OP_CONTINUATION,</span><br><span class="line">        OP_TEXT,</span><br><span class="line">        OP_BINARY,</span><br><span class="line">        OP_CLOSE,</span><br><span class="line">        OP_PING,</span><br><span class="line">        OP_PONG</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Integer&gt; FRAGMENTED_OPCODES = Arrays.asList(</span><br><span class="line">        OP_CONTINUATION, OP_TEXT, OP_BINARY</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HybiParser</span><span class="params">(WebSocketClient client)</span> </span>&#123;</span><br><span class="line">        mClient = client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] mask(<span class="keyword">byte</span>[] payload, <span class="keyword">byte</span>[] mask, <span class="keyword">int</span> offset) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mask.length == <span class="number">0</span>) <span class="keyword">return</span> payload;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; payload.length - offset; i++) &#123;</span><br><span class="line">            payload[offset + i] = (<span class="keyword">byte</span>) (payload[offset + i] ^ mask[i % <span class="number">4</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(HappyDataInputStream stream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stream.available() == -<span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">switch</span> (mStage) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    parseOpcode(stream.readByte());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    parseLength(stream.readByte());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    parseExtendedLength(stream.readBytes(mLengthSize));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    mMask = stream.readBytes(<span class="number">4</span>);</span><br><span class="line">                    mStage = <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    mPayload = stream.readBytes(mLength);</span><br><span class="line">                    emitFrame();</span><br><span class="line">                    mStage = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mClient.getListener().onDisconnect(<span class="number">0</span>, <span class="string">&quot;EOF&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseOpcode</span><span class="params">(<span class="keyword">byte</span> data)</span> <span class="keyword">throws</span> ProtocolError </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> rsv1 = (data &amp; RSV1) == RSV1;</span><br><span class="line">        <span class="keyword">boolean</span> rsv2 = (data &amp; RSV2) == RSV2;</span><br><span class="line">        <span class="keyword">boolean</span> rsv3 = (data &amp; RSV3) == RSV3;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rsv1 || rsv2 || rsv3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolError(<span class="string">&quot;RSV not zero&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mFinal   = (data &amp; FIN) == FIN;</span><br><span class="line">        mOpcode  = (data &amp; OPCODE);</span><br><span class="line">        mMask    = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">        mPayload = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!OPCODES.contains(mOpcode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolError(<span class="string">&quot;Bad opcode&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!FRAGMENTED_OPCODES.contains(mOpcode) &amp;&amp; !mFinal) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolError(<span class="string">&quot;Expected non-final packet&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mStage = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseLength</span><span class="params">(<span class="keyword">byte</span> data)</span> </span>&#123;</span><br><span class="line">        mMasked = (data &amp; MASK) == MASK;</span><br><span class="line">        mLength = (data &amp; LENGTH);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLength &gt;= <span class="number">0</span> &amp;&amp; mLength &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">            mStage = mMasked ? <span class="number">3</span> : <span class="number">4</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mLengthSize = (mLength == <span class="number">126</span>) ? <span class="number">2</span> : <span class="number">8</span>;</span><br><span class="line">            mStage      = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseExtendedLength</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> ProtocolError </span>&#123;</span><br><span class="line">        mLength = getInteger(buffer);</span><br><span class="line">        mStage  = mMasked ? <span class="number">3</span> : <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] frame(String data) &#123;</span><br><span class="line">        <span class="keyword">return</span> frame(data, OP_TEXT, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] frame(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">        <span class="keyword">return</span> frame(data, OP_BINARY, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] frame(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> opcode, <span class="keyword">int</span> errorCode)  &#123;</span><br><span class="line">        <span class="keyword">return</span> frame((Object)data, opcode, errorCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] frame(String data, <span class="keyword">int</span> opcode, <span class="keyword">int</span> errorCode) &#123;</span><br><span class="line">        <span class="keyword">return</span> frame((Object)data, opcode, errorCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] frame(Object data, <span class="keyword">int</span> opcode, <span class="keyword">int</span> errorCode) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mClosed) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Creating frame for: &quot;</span> + data + <span class="string">&quot; op: &quot;</span> + opcode + <span class="string">&quot; err: &quot;</span> + errorCode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] buffer = (data <span class="keyword">instanceof</span> String) ? decode((String) data) : (<span class="keyword">byte</span>[]) data;</span><br><span class="line">        <span class="keyword">int</span> insert = (errorCode &gt; <span class="number">0</span>) ? <span class="number">2</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> length = buffer.length + insert;</span><br><span class="line">        <span class="keyword">int</span> header = (length &lt;= <span class="number">125</span>) ? <span class="number">2</span> : (length &lt;= <span class="number">65535</span> ? <span class="number">4</span> : <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">int</span> offset = header + (mMasking ? <span class="number">4</span> : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> masked = mMasking ? MASK : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] frame = <span class="keyword">new</span> <span class="keyword">byte</span>[length + offset];</span><br><span class="line"></span><br><span class="line">        frame[<span class="number">0</span>] = (<span class="keyword">byte</span>) ((<span class="keyword">byte</span>)FIN | (<span class="keyword">byte</span>)opcode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (length &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">            frame[<span class="number">1</span>] = (<span class="keyword">byte</span>) (masked | length);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (length &lt;= <span class="number">65535</span>) &#123;</span><br><span class="line">            frame[<span class="number">1</span>] = (<span class="keyword">byte</span>) (masked | <span class="number">126</span>);</span><br><span class="line">            frame[<span class="number">2</span>] = (<span class="keyword">byte</span>) Math.floor(length / <span class="number">256</span>);</span><br><span class="line">            frame[<span class="number">3</span>] = (<span class="keyword">byte</span>) (length &amp; BYTE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            frame[<span class="number">1</span>] = (<span class="keyword">byte</span>) (masked | <span class="number">127</span>);</span><br><span class="line">            frame[<span class="number">2</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">56</span>))) &amp; BYTE);</span><br><span class="line">            frame[<span class="number">3</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">48</span>))) &amp; BYTE);</span><br><span class="line">            frame[<span class="number">4</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">40</span>))) &amp; BYTE);</span><br><span class="line">            frame[<span class="number">5</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">32</span>))) &amp; BYTE);</span><br><span class="line">            frame[<span class="number">6</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">24</span>))) &amp; BYTE);</span><br><span class="line">            frame[<span class="number">7</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">16</span>))) &amp; BYTE);</span><br><span class="line">            frame[<span class="number">8</span>] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(length / Math.pow(<span class="number">2</span>, <span class="number">8</span>)))  &amp; BYTE);</span><br><span class="line">            frame[<span class="number">9</span>] = (<span class="keyword">byte</span>) (length &amp; BYTE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (errorCode &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            frame[offset] = (<span class="keyword">byte</span>) (((<span class="keyword">int</span>) Math.floor(errorCode / <span class="number">256</span>)) &amp; BYTE);</span><br><span class="line">            frame[offset+<span class="number">1</span>] = (<span class="keyword">byte</span>) (errorCode &amp; BYTE);</span><br><span class="line">        &#125;</span><br><span class="line">        System.arraycopy(buffer, <span class="number">0</span>, frame, offset + insert, buffer.length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mMasking) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] mask = &#123;</span><br><span class="line">                (<span class="keyword">byte</span>) Math.floor(Math.random() * <span class="number">256</span>), (<span class="keyword">byte</span>) Math.floor(Math.random() * <span class="number">256</span>),</span><br><span class="line">                (<span class="keyword">byte</span>) Math.floor(Math.random() * <span class="number">256</span>), (<span class="keyword">byte</span>) Math.floor(Math.random() * <span class="number">256</span>)</span><br><span class="line">            &#125;;</span><br><span class="line">            System.arraycopy(mask, <span class="number">0</span>, frame, header, mask.length);</span><br><span class="line">            mask(frame, mask, offset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> frame;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ping</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mClient.send(frame(message, OP_PING, -<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> code, String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClosed) <span class="keyword">return</span>;</span><br><span class="line">        mClient.send(frame(reason, OP_CLOSE, code));</span><br><span class="line">        mClosed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">emitFrame</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payload = mask(mPayload, mMask, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> opcode = mOpcode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (opcode == OP_CONTINUATION) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMode == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolError(<span class="string">&quot;Mode was not set.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mBuffer.write(payload);</span><br><span class="line">            <span class="keyword">if</span> (mFinal) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] message = mBuffer.toByteArray();</span><br><span class="line">                <span class="keyword">if</span> (mMode == MODE_TEXT) &#123;</span><br><span class="line">                    mClient.getListener().onMessage(encode(message));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mClient.getListener().onMessage(message);</span><br><span class="line">                &#125;</span><br><span class="line">                reset();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == OP_TEXT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFinal) &#123;</span><br><span class="line">                String messageText = encode(payload);</span><br><span class="line">                mClient.getListener().onMessage(messageText);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mMode = MODE_TEXT;</span><br><span class="line">                mBuffer.write(payload);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == OP_BINARY) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFinal) &#123;</span><br><span class="line">                mClient.getListener().onMessage(payload);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mMode = MODE_BINARY;</span><br><span class="line">                mBuffer.write(payload);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == OP_CLOSE) &#123;</span><br><span class="line">            <span class="keyword">int</span>    code   = (payload.length &gt;= <span class="number">2</span>) ? <span class="number">256</span> * payload[<span class="number">0</span>] + payload[<span class="number">1</span>] : <span class="number">0</span>;</span><br><span class="line">            String reason = (payload.length &gt;  <span class="number">2</span>) ? encode(slice(payload, <span class="number">2</span>))     : <span class="keyword">null</span>;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Got close op! &quot;</span> + code + <span class="string">&quot; &quot;</span> + reason);</span><br><span class="line">            mClient.getListener().onDisconnect(code, reason);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == OP_PING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (payload.length &gt; <span class="number">125</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolError(<span class="string">&quot;Ping payload too large&quot;</span>); &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Sending pong!!&quot;</span>);</span><br><span class="line">            mClient.sendFrame(frame(payload, OP_PONG, -<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == OP_PONG) &#123;</span><br><span class="line">            String message = encode(payload);</span><br><span class="line">            <span class="comment">// <span class="doctag">FIXME:</span> Fire callback...</span></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Got pong! &quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mMode = <span class="number">0</span>;</span><br><span class="line">        mBuffer.reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">encode</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(buffer, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] decode(String string) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (string).getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getInteger</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> ProtocolError </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> i = byteArrayToLong(bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt; Integer.MAX_VALUE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolError(<span class="string">&quot;Bad integer: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] slice(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> start) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.copyOfRange(array, start, array.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolError</span> <span class="keyword">extends</span> <span class="title">IOException</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ProtocolError</span><span class="params">(String detailMessage)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(detailMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">byteArrayToLong</span><span class="params">(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (b.length &lt; length)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;length must be less than or equal to b.length&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> shift = (length - <span class="number">1</span> - i) * <span class="number">8</span>;</span><br><span class="line">            value += (b[i + offset] &amp; <span class="number">0x000000FF</span>) &lt;&lt; shift;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HappyDataInputStream</span> <span class="keyword">extends</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HappyDataInputStream</span><span class="params">(InputStream in)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(in);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] readBytes(<span class="keyword">int</span> length) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">            readFully(buffer);</span><br><span class="line">            <span class="keyword">return</span> buffer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebSocketClient.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codebutler.android_websockets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.os.HandlerThread;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.HttpResponseException;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.BasicLineParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.BasicNameValuePair;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLException;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.X509TrustManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.EOFException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;WebSocketClient&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> URI                      mURI;</span><br><span class="line">    <span class="keyword">private</span> Listener                 mListener;</span><br><span class="line">    <span class="keyword">private</span> Socket                   mSocket;</span><br><span class="line">    <span class="keyword">private</span> Thread                   mThread;</span><br><span class="line">    <span class="keyword">private</span> HandlerThread            mHandlerThread;</span><br><span class="line">    <span class="keyword">private</span> Handler                  mHandler;</span><br><span class="line">    <span class="keyword">private</span> List&lt;BasicNameValuePair&gt; mExtraHeaders;</span><br><span class="line">    <span class="keyword">private</span> HybiParser               mParser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mSendLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TrustManager[] sTrustManagers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTrustManagers</span><span class="params">(TrustManager[] tm)</span> </span>&#123;</span><br><span class="line">        sTrustManagers = tm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebSocketClient</span><span class="params">(URI uri, Listener listener, List&lt;BasicNameValuePair&gt; extraHeaders)</span> </span>&#123;</span><br><span class="line">        mURI          = uri;</span><br><span class="line">        mListener = listener;</span><br><span class="line">        mExtraHeaders = extraHeaders;</span><br><span class="line">        mParser       = <span class="keyword">new</span> HybiParser(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        mHandlerThread = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;websocket-thread&quot;</span>);</span><br><span class="line">        mHandlerThread.start();</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(mHandlerThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Listener <span class="title">getListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mThread != <span class="keyword">null</span> &amp;&amp; mThread.isAlive()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String secret = createSecret();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> port = (mURI.getPort() != -<span class="number">1</span>) ? mURI.getPort() : (mURI.getScheme().equals(<span class="string">&quot;wss&quot;</span>) ? <span class="number">443</span> : <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">                    String path = TextUtils.isEmpty(mURI.getPath()) ? <span class="string">&quot;/&quot;</span> : mURI.getPath();</span><br><span class="line">                    <span class="keyword">if</span> (!TextUtils.isEmpty(mURI.getQuery())) &#123;</span><br><span class="line">                        path += <span class="string">&quot;?&quot;</span> + mURI.getQuery();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String originScheme = mURI.getScheme().equals(<span class="string">&quot;wss&quot;</span>) ? <span class="string">&quot;https&quot;</span> : <span class="string">&quot;http&quot;</span>;</span><br><span class="line">                    URI origin = <span class="keyword">new</span> URI(originScheme, <span class="string">&quot;//&quot;</span> + mURI.getHost(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    SocketFactory factory =  mURI.getScheme().equals(<span class="string">&quot;wss&quot;</span>) ? getSSLSocketFactory() : SocketFactory.getDefault();</span><br><span class="line">                    mSocket = factory.createSocket(mURI.getHost(), port);</span><br><span class="line">                    </span><br><span class="line">                    PrintWriter out = <span class="keyword">new</span> PrintWriter(mSocket.getOutputStream());</span><br><span class="line">                    out.print(<span class="string">&quot;GET &quot;</span> + path + <span class="string">&quot; HTTP/1.1\r\n&quot;</span>);</span><br><span class="line">                    out.print(<span class="string">&quot;Upgrade: websocket\r\n&quot;</span>);</span><br><span class="line">                    out.print(<span class="string">&quot;Connection: Upgrade\r\n&quot;</span>);</span><br><span class="line">                    out.print(<span class="string">&quot;Host: &quot;</span> + mURI.getHost() + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">                    out.print(<span class="string">&quot;Origin: &quot;</span> + origin.toString() + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">                    out.print(<span class="string">&quot;Sec-WebSocket-Key: &quot;</span> + secret + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">                    out.print(<span class="string">&quot;Sec-WebSocket-Version: 13\r\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mExtraHeaders != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (NameValuePair pair : mExtraHeaders) &#123;</span><br><span class="line">                            out.print(String.format(<span class="string">&quot;%s: %s\r\n&quot;</span>, pair.getName(), pair.getValue()));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    out.print(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">                    out.flush();</span><br><span class="line"></span><br><span class="line">                    HybiParser.HappyDataInputStream stream = <span class="keyword">new</span> HybiParser.HappyDataInputStream(mSocket.getInputStream());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Read HTTP response status line.</span></span><br><span class="line">                    StatusLine statusLine = parseStatusLine(readLine(stream));</span><br><span class="line">                    <span class="keyword">if</span> (statusLine == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&quot;Received no reply from server.&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusLine.getStatusCode() != HttpStatus.SC_SWITCHING_PROTOCOLS) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HttpResponseException(statusLine.getStatusCode(), statusLine.getReasonPhrase());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Read HTTP response headers.</span></span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">boolean</span> validated = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (!TextUtils.isEmpty(line = readLine(stream))) &#123;</span><br><span class="line">                        Header header = parseHeader(line);</span><br><span class="line">                        <span class="keyword">if</span> (header.getName().equals(<span class="string">&quot;Sec-WebSocket-Accept&quot;</span>)) &#123;</span><br><span class="line">                            String expected = createSecretValidation(secret);</span><br><span class="line">                            String actual = header.getValue().trim();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!expected.equals(actual)) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&quot;Bad Sec-WebSocket-Accept header value.&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            validated = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!validated) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&quot;No Sec-WebSocket-Accept header.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    mListener.onConnect();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Now decode websocket frames.</span></span><br><span class="line">                    mParser.start(stream);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (EOFException ex) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;WebSocket EOF!&quot;</span>, ex);</span><br><span class="line">                    mListener.onDisconnect(<span class="number">0</span>, <span class="string">&quot;EOF&quot;</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (SSLException ex) &#123;</span><br><span class="line">                    <span class="comment">// Connection reset by peer</span></span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;Websocket SSL error!&quot;</span>, ex);</span><br><span class="line">                    mListener.onDisconnect(<span class="number">0</span>, <span class="string">&quot;SSL&quot;</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    mListener.onError(ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mSocket.close();</span><br><span class="line">                        mSocket = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;Error while disconnecting&quot;</span>, ex);</span><br><span class="line">                        mListener.onError(ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">        sendFrame(mParser.frame(data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">        sendFrame(mParser.frame(data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> StatusLine <span class="title">parseStatusLine</span><span class="params">(String line)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(line)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> BasicLineParser.parseStatusLine(line, <span class="keyword">new</span> BasicLineParser());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Header <span class="title">parseHeader</span><span class="params">(String line)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BasicLineParser.parseHeader(line, <span class="keyword">new</span> BasicLineParser());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can&#x27;t use BufferedReader because it buffers past the HTTP data.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">readLine</span><span class="params">(HybiParser.HappyDataInputStream reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readChar = reader.read();</span><br><span class="line">        <span class="keyword">if</span> (readChar == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder string = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (readChar != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (readChar != <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">                string.append((<span class="keyword">char</span>) readChar);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            readChar = reader.read();</span><br><span class="line">            <span class="keyword">if</span> (readChar == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> string.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">createSecret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] nonce = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">            nonce[i] = (<span class="keyword">byte</span>) (Math.random() * <span class="number">256</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeToString(nonce, Base64.DEFAULT).trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">createSecretValidation</span><span class="params">(String secret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MessageDigest md = MessageDigest.getInstance(<span class="string">&quot;SHA-1&quot;</span>);</span><br><span class="line">            md.update((secret + <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>).getBytes());</span><br><span class="line">            <span class="keyword">return</span> Base64.encodeToString(md.digest(), Base64.DEFAULT).trim();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendFrame</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] frame)</span> </span>&#123;</span><br><span class="line">        mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (mSendLock) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Socket not connected&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        OutputStream outputStream = mSocket.getOutputStream();</span><br><span class="line">                        outputStream.write(frame);</span><br><span class="line">                        outputStream.flush();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    mListener.onError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Listener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnect</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(<span class="keyword">int</span> code, String reason)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception error)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//为开发便利,此处信任所有证书,app正式发布时需使用信任机构签发的证书</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SSLSocketFactory <span class="title">getSSLSocketFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	<span class="comment">/*</span></span><br><span class="line"><span class="comment">    	SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);</span></span><br><span class="line"><span class="comment">    	sslContext.init(null, sTrustManagers, null);</span></span><br><span class="line"><span class="comment">        return sslContext.getSocketFactory();</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    	 TrustManager[] trustAllCerts = <span class="keyword">new</span> TrustManager[]&#123;<span class="keyword">new</span> X509TrustManager() &#123;  </span><br><span class="line">             <span class="keyword">public</span> java.security.cert.X509Certificate[] getAcceptedIssuers() &#123;  </span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">new</span> java.security.cert.X509Certificate[]&#123;&#125;;  </span><br><span class="line">             &#125;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] chain,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                            String authType)</span> <span class="keyword">throws</span> CertificateException </span>&#123;  </span><br><span class="line">             &#125;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] chain,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                            String authType)</span> <span class="keyword">throws</span> CertificateException </span>&#123;  </span><br><span class="line">             &#125;  </span><br><span class="line">         &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">         <span class="comment">// Install the all-trusting trust manager  </span></span><br><span class="line">         <span class="keyword">try</span> &#123;  </span><br><span class="line">             SSLContext sslContext = SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);  </span><br><span class="line">             sslContext.init(<span class="keyword">null</span>, trustAllCerts, <span class="keyword">new</span> java.security.SecureRandom());  </span><br><span class="line">             <span class="keyword">return</span> sslContext.getSocketFactory();  </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">             e.printStackTrace();  </span><br><span class="line">         &#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>demo:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;BasicNameValuePair&gt; extraHeaders = Arrays.asList(</span><br><span class="line">			    <span class="keyword">new</span> BasicNameValuePair(<span class="string">&quot;Cookie&quot;</span>, <span class="string">&quot;session=abcd&quot;</span>)</span><br><span class="line">		);</span><br><span class="line">		<span class="keyword">final</span> String TAG = <span class="string">&quot;WebSocketClient&quot;</span>; </span><br><span class="line">		WebSocketClient client = <span class="keyword">new</span> WebSocketClient(URI.create(<span class="string">&quot;wss://echo.websocket.org:443/&quot;</span>), <span class="keyword">new</span> WebSocketClient.Listener() &#123;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		        Log.d(TAG, <span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		        Log.d(TAG, String.format(<span class="string">&quot;Got string message! %s&quot;</span>, message));</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">		        <span class="comment">//Log.d(TAG, String.format(&quot;Got binary message! %s&quot;, toHexString(data)));</span></span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(<span class="keyword">int</span> code, String reason)</span> </span>&#123;</span><br><span class="line">		        Log.d(TAG, String.format(<span class="string">&quot;Disconnected! Code: %d Reason: %s&quot;</span>, code, reason));</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception error)</span> </span>&#123;</span><br><span class="line">		        Log.e(TAG, <span class="string">&quot;Error!&quot;</span>, error);</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line">		&#125;, extraHeaders);</span><br><span class="line"></span><br><span class="line">		client.connect();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">500</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Later… </span></span><br><span class="line">		client.send(<span class="string">&quot;SHAKEHAND&quot;</span>);</span><br><span class="line">		<span class="comment">//client.send(new byte[] &#123; (byte) 0xDE, (byte)0xAD, (byte)0xBE, (byte)0xEF &#125;);</span></span><br><span class="line">		client.disconnect();</span><br></pre></td></tr></table></figure>

</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-10-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/java/" title="java">java </a><a class="tag" href="/tags/android/" title="android">android </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninecmd.com/2020/10/08/android创建信任所有证书的websocket-ssl-wss-客户端/,NINE的博客,android创建信任所有证书的websocket ssl(wss)客户端,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/10/08/%E4%BD%BF%E7%94%A8Poco-C-%E5%BA%93%E5%88%9B%E5%BB%BAwebsocket%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE-wss-%E5%AE%A2%E6%88%B7%E7%AB%AF/" title="使用Poco C++库创建websocket安全访问(wss)客户端">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/10/08/%E5%8A%A8%E6%80%81%E5%8F%98%E5%8C%96%E8%83%8C%E6%99%AF%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9A%84%E5%A4%84%E7%90%86/" title="动态变化背景验证码的处理">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'',
  app_key:'',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'mp'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":5,"vOffset":-38},"mobile":{"show":false,"scale":0.2},"react":{"opacityDefault":0.8,"opacityOnHover":0.2},"log":false});</script></body></html>