<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>QQ大家来找茬助手 · NINE的博客</title><meta name="description" content="原理就是截取游戏界面,然后图像对比.用到的类:ScreenShot截图类,来自网络,并参考aardio的截图代码做了修改,使之更好用
using System;using System.Runtime.InteropServices;using System.Drawing;using System"><meta name="keywords" content="NINE的博客,记录与分享计算机技术"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">NINE的博客</a></h3><div class="description"><p>NINE的博客。<br> 记录与分享计算机技术。</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/xuncv"><i class="fa fa-github"></i></a></li><li><a href="mailto:xuncv1@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/ljtnine"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div><div class="beian"><a href="http://www.beian.miit.gov.cn/" target="_blank"></a><span style="height:10px;margin-left: 10px;">|</span><img src="https://qn.jixian.io/gongan.png" style="height:10px;margin-left: 10px;position: relative;top: 1px;"><span style="margin-left: 2px;"></span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>QQ大家来找茬助手</a></h3></div><div class="post-content"><p><img src="http://hexo.sz789.net/20201007224156.png"></p>
<p>原理就是截取游戏界面,然后图像对比.<br>用到的类:ScreenShot截图类,来自网络,并参考aardio的截图代码做了修改,使之更好用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line">using System.Drawing;</span><br><span class="line">using System.Drawing.Imaging;</span><br><span class="line">using System.Windows.Forms;</span><br><span class="line"></span><br><span class="line">namespace QQ找茬助手</span><br><span class="line">&#123;</span><br><span class="line">    class ScreenShot</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Creates an Image object containing a screen shot of the entire desktop?</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        public Image CaptureScreen()</span><br><span class="line">        &#123;</span><br><span class="line">            return CaptureWindow(User32.GetDesktopWindow());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Image CaptureWindow(IntPtr handle)</span><br><span class="line">        &#123;</span><br><span class="line">            MessageBox.Show(&quot;CaptureScreen()&quot;);</span><br><span class="line">            return CaptureWindow(handle,0,0,0,0);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Creates an Image object containing a screen shot of a specific window?</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;handle&quot;&gt;The handle to the window. (In windows forms, this is obtained by the Handle property)&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        public Image CaptureWindow(IntPtr handle,int x&#x3D;0,int y&#x3D;0,int w&#x3D;0,int h&#x3D;0)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; get te hDC of the target window</span><br><span class="line">            IntPtr hdcSrc &#x3D; User32.GetWindowDC(handle);</span><br><span class="line">            &#x2F;&#x2F; get the size</span><br><span class="line">            User32.RECT windowRect &#x3D; new User32.RECT();</span><br><span class="line">            User32.GetWindowRect(handle, ref windowRect);</span><br><span class="line">            int width &#x3D; w &gt; 0 ? w : (windowRect.right - windowRect.left - x);</span><br><span class="line">            int height &#x3D; h &gt; 0 ? h : (windowRect.bottom - windowRect.top - y);</span><br><span class="line">            &#x2F;&#x2F; create a device context we can copy to</span><br><span class="line">            IntPtr hdcDest &#x3D; GDI32.CreateCompatibleDC(hdcSrc);</span><br><span class="line">            &#x2F;&#x2F; create a bitmap we can copy it to,</span><br><span class="line">            &#x2F;&#x2F; using GetDeviceCaps to get the width&#x2F;height</span><br><span class="line">            IntPtr hBitmap &#x3D; GDI32.CreateCompatibleBitmap(hdcSrc, width, height);</span><br><span class="line">            &#x2F;&#x2F; select the bitmap object</span><br><span class="line">            IntPtr hOld &#x3D; GDI32.SelectObject(hdcDest, hBitmap);</span><br><span class="line">            &#x2F;&#x2F; bitblt over</span><br><span class="line">            GDI32.BitBlt(hdcDest, 0, 0, width, height, hdcSrc, x, y, GDI32.SRCCOPY | GDI32.CAPTUREBLT);</span><br><span class="line">            &#x2F;&#x2F; restore selection</span><br><span class="line">            GDI32.SelectObject(hdcDest, hOld);</span><br><span class="line">            &#x2F;&#x2F; clean up </span><br><span class="line">            GDI32.DeleteDC(hdcDest);</span><br><span class="line">            User32.ReleaseDC(handle, hdcSrc);</span><br><span class="line">            &#x2F;&#x2F; get a .NET image object for it</span><br><span class="line">            Image img &#x3D; Image.FromHbitmap(hBitmap);</span><br><span class="line">            &#x2F;&#x2F; free up the Bitmap object</span><br><span class="line">            GDI32.DeleteObject(hBitmap);</span><br><span class="line">            return img;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Captures a screen shot of a specific window, and saves it to a file?</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;handle&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filename&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;format&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void CaptureWindowToFile(IntPtr handle, string filename, ImageFormat format)</span><br><span class="line">        &#123;</span><br><span class="line">            Image img &#x3D; CaptureWindow(handle);</span><br><span class="line">            img.Save(filename, format);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Captures a screen shot of the entire desktop, and saves it to a file?</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;filename&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;format&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void CaptureScreenToFile(string filename, ImageFormat format)</span><br><span class="line">        &#123;</span><br><span class="line">            Image img &#x3D; CaptureScreen();</span><br><span class="line">            img.Save(filename, format);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Helper class containing Gdi32 API functions</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private class GDI32</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            public const int SRCCOPY &#x3D; 0x00CC0020; &#x2F;&#x2F; BitBlt dwRop parameter</span><br><span class="line">            public const int CAPTUREBLT &#x3D; 0x40000000;</span><br><span class="line">            [DllImport(&quot;gdi32.dll&quot;)]</span><br><span class="line">            public static extern bool BitBlt(IntPtr hObject, int nXDest, int nYDest,</span><br><span class="line">                int nWidth, int nHeight, IntPtr hObjectSource,</span><br><span class="line">                int nXSrc, int nYSrc, int dwRop);</span><br><span class="line">            [DllImport(&quot;gdi32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr CreateCompatibleBitmap(IntPtr hDC, int nWidth,</span><br><span class="line">                int nHeight);</span><br><span class="line">            [DllImport(&quot;gdi32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr CreateCompatibleDC(IntPtr hDC);</span><br><span class="line">            [DllImport(&quot;gdi32.dll&quot;)]</span><br><span class="line">            public static extern bool DeleteDC(IntPtr hDC);</span><br><span class="line">            [DllImport(&quot;gdi32.dll&quot;)]</span><br><span class="line">            public static extern bool DeleteObject(IntPtr hObject);</span><br><span class="line">            [DllImport(&quot;gdi32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr SelectObject(IntPtr hDC, IntPtr hObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Helper class containing User32 API functions</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private class User32</span><br><span class="line">        &#123;</span><br><span class="line">            [StructLayout(LayoutKind.Sequential)]</span><br><span class="line">            public struct RECT</span><br><span class="line">            &#123;</span><br><span class="line">                public int left;</span><br><span class="line">                public int top;</span><br><span class="line">                public int right;</span><br><span class="line">                public int bottom;</span><br><span class="line">            &#125;</span><br><span class="line">            [DllImport(&quot;user32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr GetDesktopWindow();</span><br><span class="line">            [DllImport(&quot;user32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr GetWindowDC(IntPtr hWnd);</span><br><span class="line">            [DllImport(&quot;user32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr ReleaseDC(IntPtr hWnd, IntPtr hDC);</span><br><span class="line">            [DllImport(&quot;user32.dll&quot;)]</span><br><span class="line">            public static extern IntPtr GetWindowRect(IntPtr hWnd, ref RECT rect);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑代码:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.ComponentModel;</span><br><span class="line">using System.Data;</span><br><span class="line">using System.Drawing;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Windows.Forms;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line">using System.Threading;</span><br><span class="line"></span><br><span class="line">namespace QQ找茬助手</span><br><span class="line">&#123;</span><br><span class="line">    public partial class Form1 : Form</span><br><span class="line">    &#123;</span><br><span class="line">        public Form1()</span><br><span class="line">        &#123;</span><br><span class="line">            InitializeComponent();</span><br><span class="line">        &#125;</span><br><span class="line">        [DllImport(&quot;user32.dll&quot;)]</span><br><span class="line">        private extern static IntPtr FindWindow(string lpClassName, string lpWindowName);</span><br><span class="line">        [DllImport(&quot;user32.dll&quot;)]</span><br><span class="line">        private extern static bool SetWindowPos(IntPtr hwnd, IntPtr hwndlnsertAfter, int X, int Y, int cx, int cy, int Flags);</span><br><span class="line"></span><br><span class="line">        private void Form1_Load(object sender, EventArgs e)</span><br><span class="line">        &#123;</span><br><span class="line">            timer1.Enabled &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private void timer1_Tick(object sender, EventArgs e)</span><br><span class="line">        &#123;</span><br><span class="line">            toolStripStatusLabel2.Text &#x3D; DateTime.Now.ToLongTimeString();</span><br><span class="line">            Point cp &#x3D; pictureBox1.PointToClient(new Point(MousePosition.X, MousePosition.Y ));</span><br><span class="line">            string pos &#x3D; string.Format(&quot;&#123;0&#125;,&#123;1&#125;&quot;, cp.X,cp.Y);</span><br><span class="line">            toolStripStatusLabel4.Text &#x3D; pos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private void button1_Click(object sender, EventArgs e)</span><br><span class="line">        &#123;</span><br><span class="line">            IntPtr hwnd &#x3D; FindWindow(&quot;#32770&quot;, &quot;大家来找茬&quot;);</span><br><span class="line">            if (hwnd.ToInt32()&#x3D;&#x3D;0)</span><br><span class="line">            &#123;</span><br><span class="line">                MessageBox.Show(&quot;游戏未打开&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            SetWindowPos(hwnd, IntPtr.Zero, 0, 0, 0, 0, 0x1 | 0x4);</span><br><span class="line">            Thread.Sleep(80);</span><br><span class="line">            &#x2F;&#x2F;Application.DoEvents();</span><br><span class="line">            ScreenShot ss &#x3D; new ScreenShot();</span><br><span class="line">            Image Lwindow &#x3D; ss.CaptureWindow(hwnd, 10, 185, 381, 287);</span><br><span class="line">            Image Rwindow &#x3D; ss.CaptureWindow(hwnd, 403, 185, 381, 287);</span><br><span class="line">            Bitmap left &#x3D; new Bitmap(Lwindow);</span><br><span class="line">            Bitmap right &#x3D; new Bitmap(Rwindow);</span><br><span class="line">            Color n &#x3D; Color.FromName(&quot;Green&quot;);</span><br><span class="line">            for (int i&#x3D;1;i&lt;left.Width;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                for (int j&#x3D;1;j&lt;left.Height;j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Color Lcolor &#x3D; left.GetPixel(i,j);</span><br><span class="line">                    Color Rcolor &#x3D; right.GetPixel(i, j);</span><br><span class="line">                    float Ln &#x3D; Lcolor.GetHue();</span><br><span class="line">                    float Rn &#x3D; Rcolor.GetHue();</span><br><span class="line">                    if (Ln!&#x3D;Rn)</span><br><span class="line">                    &#123;</span><br><span class="line">                        right.SetPixel(i, j, n);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pictureBox1.Image &#x3D; right;</span><br><span class="line">            &#x2F;&#x2F;left.Dispose();</span><br><span class="line">            &#x2F;&#x2F;right.Dispose();</span><br><span class="line">            &#x2F;&#x2F;Lwindow.Dispose();</span><br><span class="line">            &#x2F;&#x2F;Rwindow.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private void pictureBox1_Click(object sender, EventArgs e)</span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-10-07</span><i class="fa fa-tag"></i><a class="tag" href="/tags/aardio/" title="aardio">aardio </a><a class="tag" href="/tags/c/" title="c#">c# </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninecmd.com/2020/10/07/QQ大家来找茬助手/,NINE的博客,QQ大家来找茬助手,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/10/07/UDP-FLOOD/" title="UDP FLOOD">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/10/07/QQ%E5%A4%A7%E5%AE%B6%E6%9D%A5%E6%89%BE%E8%8C%AC%E5%8A%A9%E6%89%8B-aardio/" title="QQ大家来找茬助手-aardio">下一篇</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":5,"vOffset":-38},"mobile":{"show":false,"scale":0.2},"react":{"opacityDefault":0.8,"opacityOnHover":0.2},"log":false});</script></body></html>