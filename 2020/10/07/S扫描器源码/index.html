<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>S扫描器源码 · NINE的博客</title><meta name="description" content="#pragma comment(linker, &amp;quot;/subsystem:console /FILEALIGN:0x200 /opt:nowin98 /IGNORE:4078 /MERGE:.rdata=.text /MERGE:.data=.text /section:.text,ERW&amp;"><meta name="keywords" content="NINE的博客,记录与分享计算机技术"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">NINE的博客</a></h3><div class="description"><p>NINE的博客。<br> 记录与分享计算机技术。</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/xuncv"><i class="fa fa-github"></i></a></li><li><a href="mailto:xuncv1@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/ljtnine/"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div><div class="beian"><a href="http://www.beian.miit.gov.cn/" target="_blank"></a><span style="height:10px;margin-left: 10px;">|</span><img src="https://qn.jixian.io/gongan.png" style="height:10px;margin-left: 10px;position: relative;top: 1px;"><span style="margin-left: 2px;"></span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>S扫描器源码</a></h3></div><div class="post-content"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/subsystem:console /FILEALIGN:0x200 /opt:nowin98 /IGNORE:4078 /MERGE:.rdata=.text /MERGE:.data=.text /section:.text,ERW&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WIN32_WINNT	0x0403</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Iphlpapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Iphlpapi.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(push, 1)<span class="comment">//取消内存大小自动对齐</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">iphdr</span>    </span></span><br><span class="line"><span class="class">&#123;</span>   </span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> h_lenver; <span class="comment">//4位首部长度+4位IP版本号    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> tos; <span class="comment">//8位服务类型TOS    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> total_len; <span class="comment">//16位总长度（字节）    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> ident; <span class="comment">//16位标识    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> frag_and_flags; <span class="comment">//3位标志位    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> ttl; <span class="comment">//8位生存时间 TTL    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> proto; <span class="comment">//8位协议 (TCP, UDP 或其他)    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> checksum; <span class="comment">//16位IP首部校验和    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> sourceIP; <span class="comment">//32位源IP地址    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> destIP; <span class="comment">//32位目的IP地址    </span></span><br><span class="line">&#125;IP_HEADER;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">tcphdr</span> //定义<span class="title">TCP</span>首部    </span></span><br><span class="line"><span class="class">&#123;</span>   </span><br><span class="line">	USHORT th_sport; <span class="comment">//16位源端口    </span></span><br><span class="line">	USHORT th_dport; <span class="comment">//16位目的端口    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> th_seq; <span class="comment">//32位序列号    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> th_ack; <span class="comment">//32位确认号    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> th_lenres; <span class="comment">//4位首部长度/6位保留字    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> th_flag; <span class="comment">//6位标志位    </span></span><br><span class="line">	USHORT th_win; <span class="comment">//16位窗口大小    </span></span><br><span class="line">	USHORT th_sum; <span class="comment">//16位校验和    </span></span><br><span class="line">	USHORT th_urp; <span class="comment">//16位紧急数据偏移量    </span></span><br><span class="line">&#125;TCP_HEADER;    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> //定义<span class="title">TCP</span>伪首部    </span></span><br><span class="line"><span class="class">&#123;</span>   </span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> saddr; <span class="comment">//源地址    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> daddr; <span class="comment">//目的地址    </span></span><br><span class="line">	<span class="keyword">char</span> mbz;   </span><br><span class="line">	<span class="keyword">char</span> ptcl; <span class="comment">//协议类型    </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> tcpl; <span class="comment">//TCP长度    </span></span><br><span class="line">&#125;psd_header;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CRITICAL_SECTION	_cs;</span><br><span class="line"></span><br><span class="line">BOOL	_isLog = FALSE;</span><br><span class="line">BOOL	_isBanner = FALSE;</span><br><span class="line">BOOL	_isRangeScan;</span><br><span class="line">BOOL	_isSinglePort;</span><br><span class="line">BOOL	_isBreak;</span><br><span class="line">BOOL	_isMultiplePort;</span><br><span class="line"></span><br><span class="line">DWORD	_startIp;</span><br><span class="line">DWORD	_endIp;</span><br><span class="line">DWORD	_portToScan;</span><br><span class="line">DWORD	_portScanSingle;</span><br><span class="line">DWORD	dword_407090;</span><br><span class="line">DWORD	_portsTotal;</span><br><span class="line">DWORD	_threadsUsed;</span><br><span class="line">DWORD	_totalPortsOpen;</span><br><span class="line">DWORD	_ipScanned;</span><br><span class="line">DWORD	_tcpTimeout = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">u_long	_bindIpAddr;</span><br><span class="line">SOCKET	_s; <span class="comment">// idb</span></span><br><span class="line">LPCSTR	_logFile = <span class="string">&quot;Result.txt&quot;</span>; <span class="comment">// idb</span></span><br><span class="line"><span class="keyword">char</span>	_httpRequest[] = <span class="string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">void</span> *	_portsArray;</span><br><span class="line"></span><br><span class="line">LONG	_maxThreads;</span><br><span class="line">HANDLE	_semaphore;</span><br><span class="line">BOOL	_isHttp = FALSE;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getrandom</span><span class="params">(<span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LARGE_INTEGER tick; </span><br><span class="line">	QueryPerformanceCounter(&amp;tick);</span><br><span class="line">	<span class="keyword">return</span> (begin + tick.LowPart % (end - begin + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">help</span><span class="params">(<span class="keyword">char</span> * app)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Usage:   %s TCP/SYN StartIP [EndIP] Ports [Threads] [/T(N)] [/(H)Banner] [/Save]\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12 12.12.12.254 80 512\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12/24 80 512\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12/24 80 512 /T8 /Save\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12 12.12.12.254 80 512 /HBanner\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12 12.12.12.254 21 512 /Banner\n&quot;</span>, app);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12 1-65535 512\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12 12.12.12.254 21,3389,5631 512\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s TCP 12.12.12.12 21,3389,5631 512\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s SYN 12.12.12.12 12.12.12.254 80\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s SYN 12.12.12.12 1-65535\n&quot;</span>, app);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Example: %s SYN 12.12.12.12 12.12.12.254 21,80,3389\n&quot;</span>, app);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Example: %s SYN 12.12.12.12 21,80,3389\n&quot;</span>, app);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleCtrlHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwCtrlType   <span class="comment">//  control signal type</span></span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (dwCtrlType) </span><br><span class="line">	&#123; </span><br><span class="line">		<span class="comment">/* Handle the CTRL-C signal. */</span></span><br><span class="line">    <span class="keyword">case</span> CTRL_C_EVENT: </span><br><span class="line">    <span class="keyword">case</span> CTRL_CLOSE_EVENT: </span><br><span class="line">    <span class="keyword">case</span> CTRL_BREAK_EVENT:  </span><br><span class="line">    <span class="keyword">case</span> CTRL_LOGOFF_EVENT: </span><br><span class="line">    <span class="keyword">case</span> CTRL_SHUTDOWN_EVENT:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CTRL+C Is Pressed                          \n&quot;</span>);</span><br><span class="line">		_isBreak = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">return</span> TRUE;		</span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isWin2K</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> result; <span class="comment">// eax@8</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">OSVERSIONINFOA</span> <span class="title">VersionInformation</span>;</span> <span class="comment">// [sp+0h] [bp-94h]@2</span></span><br><span class="line">	</span><br><span class="line">	VersionInformation.dwOSVersionInfoSize = <span class="number">148</span>;</span><br><span class="line">	<span class="keyword">if</span> ( GetVersionExA(&amp;VersionInformation) )</span><br><span class="line">	&#123;</span><br><span class="line">		result = VersionInformation.dwPlatformId == <span class="number">2</span> &amp;&amp; VersionInformation.dwMajorVersion == <span class="number">5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		result = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----- (00403704) --------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">initWinsock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WSAData wsaData;</span><br><span class="line">	<span class="keyword">return</span> (WSAStartup(<span class="number">0x202</span>u, &amp;wsaData) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----- (004040C0) --------------------------------------------------------</span></span><br><span class="line"><span class="function">BOOL __cdecl <span class="title">logWriteBuffer</span><span class="params">(LPCSTR lpFileName, <span class="keyword">char</span> *lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL result; <span class="comment">// eax@4</span></span><br><span class="line">	HANDLE v4; <span class="comment">// eax@3</span></span><br><span class="line">	DWORD v5; <span class="comment">// eax@5</span></span><br><span class="line">	DWORD NumberOfBytesWritten; <span class="comment">// [sp+0h] [bp-Ch]@2</span></span><br><span class="line">	HANDLE hObject; <span class="comment">// [sp+8h] [bp-4h]@3</span></span><br><span class="line">	BOOL v8; <span class="comment">// [sp+4h] [bp-8h]@5</span></span><br><span class="line"></span><br><span class="line">	hObject = <span class="number">0</span>;</span><br><span class="line">	v4 = CreateFileA(lpFileName, <span class="number">0xC0000000</span>u, <span class="number">2u</span>, <span class="number">0</span>, <span class="number">4u</span>, <span class="number">0x80</span>u, <span class="number">0</span>);</span><br><span class="line">	hObject = v4;</span><br><span class="line">	<span class="keyword">if</span> ( v4 == (HANDLE)<span class="number">-1</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		result = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		SetFilePointer(hObject, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2u</span>);</span><br><span class="line">		v5 = lstrlen(lpBuffer);</span><br><span class="line">		v8 = WriteFile(hObject, lpBuffer, v5, &amp;NumberOfBytesWritten, <span class="number">0</span>);</span><br><span class="line">		CloseHandle(hObject);</span><br><span class="line">		result = v8;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//----- (00404147) --------------------------------------------------------</span></span><br><span class="line"><span class="function">BOOL __cdecl <span class="title">logWriteTime</span><span class="params">(LPCSTR lpFileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD Buffer[<span class="number">64</span>]; <span class="comment">// [sp+0h] [bp-110h]@2</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">SYSTEMTIME</span> <span class="title">SystemTime</span>;</span> <span class="comment">// [sp+100h] [bp-10h]@3</span></span><br><span class="line">	</span><br><span class="line">	GetLocalTime(&amp;SystemTime);</span><br><span class="line">	wsprintf(</span><br><span class="line">		(<span class="keyword">char</span> *)Buffer,</span><br><span class="line">		<span class="string">&quot;Performing Time: %d/%d/%d %d:%d:%d --&gt; &quot;</span>,</span><br><span class="line">		SystemTime.wMonth,</span><br><span class="line">		SystemTime.wDay,</span><br><span class="line">		SystemTime.wYear,</span><br><span class="line">		SystemTime.wHour,</span><br><span class="line">		SystemTime.wMinute,</span><br><span class="line">		SystemTime.wSecond);</span><br><span class="line">	<span class="keyword">return</span> logWriteBuffer(lpFileName, (<span class="keyword">char</span> *)Buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//----- (004041D8) --------------------------------------------------------</span></span><br><span class="line"><span class="function">BOOL <span class="title">myRecv</span><span class="params">(SOCKET s, <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret; <span class="comment">// eax@10</span></span><br><span class="line">	BOOL result; <span class="comment">// eax@12</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span> <span class="comment">// [sp+4h] [bp-110h]@3</span></span><br><span class="line">	fd_set readfds; <span class="comment">// [sp+10h] [bp-104h]@3</span></span><br><span class="line"></span><br><span class="line">	result = FALSE;</span><br><span class="line">	timeout.tv_sec = <span class="number">3</span>;</span><br><span class="line">	timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_isHttp)</span><br><span class="line">	&#123;</span><br><span class="line">		ret = send(s, _httpRequest, <span class="keyword">sizeof</span>(_httpRequest), <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	FD_ZERO(&amp;readfds);</span><br><span class="line">	FD_SET(s, &amp;readfds);</span><br><span class="line">	ret = select(<span class="number">0</span>, &amp;readfds, <span class="number">0</span>, <span class="number">0</span>, &amp;timeout);</span><br><span class="line">	<span class="keyword">if</span> ( ret &amp;&amp; ret != <span class="number">-1</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ( FD_ISSET(s, &amp;readfds) )</span><br><span class="line">		&#123;</span><br><span class="line">			result = recv(s, buf, len, <span class="number">0</span>) &gt; <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">getBanner</span><span class="params">(<span class="keyword">char</span> *response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax@4</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// edi@6</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">int</span> v5; <span class="comment">// edi@9</span></span><br><span class="line">	<span class="keyword">size_t</span> v7; <span class="comment">// [sp+0h] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( response )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span>	len = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (_isHttp)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span> * tag = <span class="string">&quot;Server: &quot;</span>;</span><br><span class="line">			<span class="keyword">char</span> * serverBanner = <span class="built_in">strstr</span>(response, tag);</span><br><span class="line">			<span class="keyword">if</span> (!serverBanner)</span><br><span class="line">			&#123;</span><br><span class="line">				serverBanner = response;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				serverBanner += lstrlen(tag);</span><br><span class="line">			&#125;			</span><br><span class="line">			len = lstrlen(serverBanner);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (serverBanner[i] == <span class="string">&#x27;\r&#x27;</span> || serverBanner[i] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					serverBanner[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> serverBanner;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			len = lstrlen(response);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lstrlen(response); i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (response[i] == <span class="string">&#x27;\r&#x27;</span> || response[i] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					response[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		result = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		result = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//----- (004037A8) --------------------------------------------------------</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">tcpScanThread</span><span class="params">(LPVOID lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ret; <span class="comment">// eax@5</span></span><br><span class="line">  <span class="keyword">char</span> banner[<span class="number">0x400</span>]; <span class="comment">// [sp+0h] [bp-330h]@2</span></span><br><span class="line">  u_long hostlong; <span class="comment">// [sp+208h] [bp-128h]@3</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [sp+200h] [bp-130h]@3</span></span><br><span class="line">  <span class="keyword">char</span> response[<span class="number">200</span>]; <span class="comment">// [sp+114h] [bp-21Ch]@3</span></span><br><span class="line">  SOCKET s; <span class="comment">// [sp+228h] [bp-108h]@3</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span> <span class="comment">// [sp+20Ch] [bp-124h]@3</span></span><br><span class="line">  u_long argp; <span class="comment">// [sp+204h] [bp-12Ch]@3</span></span><br><span class="line">  <span class="keyword">char</span> targetHost[<span class="number">0x200</span>]; <span class="comment">// [sp+1E0h] [bp-150h]@3</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span>;</span> <span class="comment">// [sp+214h] [bp-11Ch]@4</span></span><br><span class="line">  fd_set writefds; <span class="comment">// [sp+22Ch] [bp-104h]@8</span></span><br><span class="line">  <span class="keyword">int</span> recvLen = <span class="number">0</span>;</span><br><span class="line">  hostlong = *(DWORD *)lparam;</span><br><span class="line">  v9 = *((DWORD *)lparam + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">free</span>(lparam);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(response, <span class="number">0</span>, <span class="keyword">sizeof</span>(response));</span><br><span class="line">  s = <span class="number">-1</span>;</span><br><span class="line">  timeout.tv_sec = _tcpTimeout;</span><br><span class="line">  timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">  argp = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(targetHost, <span class="number">0</span>, <span class="keyword">sizeof</span>(targetHost));</span><br><span class="line">  s = socket(AF_INET, SOCK_STREAM, IPPROTO_IP);</span><br><span class="line">  <span class="keyword">if</span> ( s != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa)); </span><br><span class="line">	sa.sin_family = AF_INET; </span><br><span class="line">	sa.sin_addr.s_addr = htonl(hostlong); </span><br><span class="line">	sa.sin_port = htons(v9); </span><br><span class="line">    argp = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ioctlsocket(s, FIONBIO, &amp;argp) != <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ret = connect(s, (<span class="keyword">const</span> struct sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">      <span class="keyword">if</span> ( ret != <span class="number">-1</span> )</span><br><span class="line">	  &#123;</span><br><span class="line">        <span class="keyword">goto</span> __recv;</span><br><span class="line">	  &#125;</span><br><span class="line">      <span class="keyword">if</span> ( WSAGetLastError() == WSAEWOULDBLOCK)</span><br><span class="line">      &#123;</span><br><span class="line">		FD_ZERO(&amp;writefds);</span><br><span class="line">		FD_SET(s, &amp;writefds);</span><br><span class="line">        ret = select(<span class="number">0</span>, <span class="number">0</span>, &amp;writefds, <span class="number">0</span>, &amp;timeout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( FD_ISSET(s, &amp;writefds) )</span><br><span class="line">        &#123;</span><br><span class="line">__recv:</span><br><span class="line">          wsprintf(</span><br><span class="line">            targetHost,</span><br><span class="line">            <span class="string">&quot;%d.%d.%d.%d&quot;</span>,</span><br><span class="line">            hostlong &gt;&gt; <span class="number">24</span>,</span><br><span class="line">            (hostlong &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>,</span><br><span class="line">            (<span class="keyword">unsigned</span> __int16)((WORD)hostlong &gt;&gt; <span class="number">8</span>),</span><br><span class="line">            (<span class="keyword">unsigned</span> __int8)hostlong);</span><br><span class="line">          EnterCriticalSection(&amp;_cs);</span><br><span class="line">          ++_totalPortsOpen;</span><br><span class="line">          LeaveCriticalSection(&amp;_cs);</span><br><span class="line">		  <span class="keyword">const</span> <span class="keyword">char</span> *	responseBanner = <span class="literal">NULL</span>;</span><br><span class="line">          <span class="keyword">if</span> ( _isBanner )</span><br><span class="line">          &#123;</span><br><span class="line">				  <span class="comment">// 切回同步模式</span></span><br><span class="line">				argp = <span class="number">0</span>;</span><br><span class="line">				ioctlsocket(s, FIONBIO, &amp;argp);</span><br><span class="line">				recvLen = myRecv(s, response, <span class="keyword">sizeof</span>(response));</span><br><span class="line">				EnterCriticalSection(&amp;_cs);</span><br><span class="line">				<span class="keyword">if</span> ( recvLen )</span><br><span class="line">				&#123;</span><br><span class="line">				  responseBanner = getBanner(response);</span><br><span class="line">				  <span class="keyword">if</span> ( lstrlen(responseBanner) &lt;= <span class="number">6</span> )</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;%-16s %-5d -&gt; \&quot;%s\&quot;           \n&quot;</span>, targetHost, v9, responseBanner);</span><br><span class="line">				  <span class="keyword">else</span></span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;%-16s %-5d -&gt; \&quot;%s\&quot;\n&quot;</span>, targetHost, v9, responseBanner);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">				  <span class="built_in">printf</span>(<span class="string">&quot;%-16s %-5d -&gt; NULL             \n&quot;</span>, targetHost, v9);</span><br><span class="line">				&#125;</span><br><span class="line">				LeaveCriticalSection(&amp;_cs);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            EnterCriticalSection(&amp;_cs);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%-16s %-5d Open             \n&quot;</span>, targetHost, v9);</span><br><span class="line">            LeaveCriticalSection(&amp;_cs);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">memset</span>(banner, <span class="number">0</span>, <span class="keyword">sizeof</span>(banner));</span><br><span class="line">            <span class="keyword">if</span> ( _isBanner )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( recvLen )</span><br><span class="line">                wsprintf(banner, <span class="string">&quot;%-16s %-5d -&gt; \&quot;%s\&quot;\r\n&quot;</span>, targetHost, v9, responseBanner);</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                wsprintf(banner, <span class="string">&quot;%-16s %-5d -&gt; NULL\r\n&quot;</span>, targetHost, v9);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              wsprintf(banner, <span class="string">&quot;%-16s %-5d Open             \r\n&quot;</span>, targetHost, v9);</span><br><span class="line">            &#125;</span><br><span class="line">            EnterCriticalSection(&amp;_cs);</span><br><span class="line">            logWriteBuffer(_logFile, banner);</span><br><span class="line">            LeaveCriticalSection(&amp;_cs);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  EnterCriticalSection(&amp;_cs);</span><br><span class="line">  ++_ipScanned;</span><br><span class="line">  <span class="keyword">if</span> ( _threadsUsed )</span><br><span class="line">    --_threadsUsed;</span><br><span class="line">  ReleaseSemaphore(_semaphore, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  LeaveCriticalSection(&amp;_cs);</span><br><span class="line">  closesocket(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">USHORT <span class="title">checkSum</span><span class="params">(<span class="keyword">void</span> * buffer, <span class="keyword">int</span> size)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span> cksum=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">while</span> (size &gt;<span class="number">1</span>) &#123;</span><br><span class="line">              cksum += *(USHORT *)buffer;</span><br><span class="line">              size -= <span class="keyword">sizeof</span>(USHORT);</span><br><span class="line">			  buffer = (<span class="keyword">char</span> *)buffer + <span class="keyword">sizeof</span>(USHORT);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (size) cksum += *(UCHAR*) buffer;</span><br><span class="line">       cksum = (cksum &gt;&gt; <span class="number">16</span>) + (cksum&amp;<span class="number">0xffff</span>);</span><br><span class="line">       cksum += (cksum &gt;&gt; <span class="number">16</span>);</span><br><span class="line">       <span class="keyword">return</span> (USHORT) (~cksum); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>	<span class="title">buildSynPacket</span><span class="params">(<span class="keyword">char</span> * buf, u_long saddr, u_long sport, u_long daddr, u_long dport)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>	len = <span class="number">0</span>;</span><br><span class="line">	IP_HEADER ip_header;   </span><br><span class="line">	TCP_HEADER tcp_header;</span><br><span class="line">	<span class="comment">//填充IP首部    </span></span><br><span class="line">	ip_header.h_lenver=(<span class="number">4</span>&lt;&lt;<span class="number">4</span> | <span class="keyword">sizeof</span>(ip_header)/<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>));   </span><br><span class="line">	<span class="comment">//高四位IP版本号，低四位首部长度    </span></span><br><span class="line">	ip_header.total_len=htons(<span class="keyword">sizeof</span>(IP_HEADER)+<span class="keyword">sizeof</span>(TCP_HEADER)); <span class="comment">//16位总长度（字节）    </span></span><br><span class="line">	ip_header.ident=<span class="number">1</span>; <span class="comment">//16位标识    </span></span><br><span class="line">	ip_header.frag_and_flags = <span class="number">0</span>; <span class="comment">//3位标志位    </span></span><br><span class="line">	ip_header.ttl = <span class="number">128</span>; <span class="comment">//8位生存时间TTL    </span></span><br><span class="line">	ip_header.proto = IPPROTO_TCP; <span class="comment">//8位协议(TCP,UDP…)    </span></span><br><span class="line">	ip_header.checksum = <span class="number">0</span>; <span class="comment">//16位IP首部校验和    </span></span><br><span class="line">	ip_header.sourceIP = saddr; <span class="comment">//32位源IP地址    </span></span><br><span class="line">	ip_header.destIP = daddr; <span class="comment">//32位目的IP地址    </span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//填充TCP首部    </span></span><br><span class="line">	tcp_header.th_sport = sport; <span class="comment">//源端口号    </span></span><br><span class="line">	tcp_header.th_lenres=(<span class="keyword">sizeof</span>(TCP_HEADER)/<span class="number">4</span>&lt;&lt;<span class="number">4</span>|<span class="number">0</span>); <span class="comment">//TCP长度和保留位    </span></span><br><span class="line">	tcp_header.th_win = htons(<span class="number">0x4000</span>);    </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//填充TCP伪首部（用于计算校验和，并不真正发送）    </span></span><br><span class="line">	psd_header.saddr=ip_header.sourceIP;   </span><br><span class="line">	psd_header.daddr=ip_header.destIP;   </span><br><span class="line">	psd_header.mbz=<span class="number">0</span>;   </span><br><span class="line">	psd_header.ptcl=IPPROTO_TCP;   </span><br><span class="line">	psd_header.tcpl=htons(<span class="keyword">sizeof</span>(tcp_header)); </span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	tcp_header.th_dport = dport; <span class="comment">//目的端口号</span></span><br><span class="line">	tcp_header.th_ack=<span class="number">0</span>; <span class="comment">//ACK序列号置为0</span></span><br><span class="line">	tcp_header.th_flag=<span class="number">2</span>; <span class="comment">//SYN 标志</span></span><br><span class="line">	tcp_header.th_seq = sport <span class="number">-1</span>; <span class="comment">//SYN序列号随机</span></span><br><span class="line">	tcp_header.th_urp=<span class="number">0</span>; <span class="comment">//偏移</span></span><br><span class="line">	tcp_header.th_sum=<span class="number">0</span>; <span class="comment">//校验和</span></span><br><span class="line">	<span class="comment">//计算TCP校验和，计算校验和时需要包括TCP pseudo header </span></span><br><span class="line">	<span class="built_in">memcpy</span>(buf,&amp;psd_header,<span class="keyword">sizeof</span>(psd_header)); </span><br><span class="line">	<span class="built_in">memcpy</span>(buf+<span class="keyword">sizeof</span>(psd_header),&amp;tcp_header,<span class="keyword">sizeof</span>(tcp_header));</span><br><span class="line">	tcp_header.th_sum=checkSum(buf,<span class="keyword">sizeof</span>(psd_header)+<span class="keyword">sizeof</span>(tcp_header));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//计算IP校验和</span></span><br><span class="line">	<span class="built_in">memcpy</span>(buf,&amp;ip_header,<span class="keyword">sizeof</span>(ip_header));</span><br><span class="line">	<span class="built_in">memcpy</span>(buf+<span class="keyword">sizeof</span>(ip_header),&amp;tcp_header,<span class="keyword">sizeof</span>(tcp_header));</span><br><span class="line">	<span class="built_in">memset</span>(buf+<span class="keyword">sizeof</span>(ip_header)+<span class="keyword">sizeof</span>(tcp_header),<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">	len=<span class="keyword">sizeof</span>(ip_header)+<span class="keyword">sizeof</span>(tcp_header);</span><br><span class="line">	ip_header.checksum=checkSum(buf,len);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//填充发送缓冲区</span></span><br><span class="line">	<span class="built_in">memcpy</span>(buf,&amp;ip_header,<span class="keyword">sizeof</span>(ip_header));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有点问题，发出去的数据包不对</span></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">synScan</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> Buffer[<span class="number">0x190</span>]; <span class="comment">// [sp+0h] [bp-2C0h]@2</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [sp+140h] [bp-180h]@3</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [sp+150h] [bp-170h]@3</span></span><br><span class="line">  SOCKET s; <span class="comment">// [sp+154h] [bp-16Ch]@3</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">0x100</span>]; <span class="comment">// [sp+198h] [bp-128h]@3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> optval; <span class="comment">// [sp+13Ch] [bp-184h]@3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> sendTimeout; <span class="comment">// [sp+138h] [bp-188h]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> portsScanned; <span class="comment">// [sp+170h] [bp-150h]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v15; <span class="comment">// [sp+14Ch] [bp-174h]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v16; <span class="comment">// [sp+148h] [bp-178h]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> dport; <span class="comment">// [sp+178h] [bp-148h]@6</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> counter; <span class="comment">// [sp+174h] [bp-14Ch]@6</span></span><br><span class="line">  u_long hostlong; <span class="comment">// [sp+158h] [bp-168h]@6</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">dst</span>;</span> <span class="comment">// [sp+17Ch] [bp-144h]@9</span></span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// [sp+16Ch] [bp-154h]@9</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v49; <span class="comment">// [sp+12Ch] [bp-194h]@11</span></span><br><span class="line">  <span class="keyword">char</span> Dest[<span class="number">0x20</span>]; <span class="comment">// [sp+110h] [bp-1B0h]@37</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  v8 = _portScanSingle;</span><br><span class="line">  v9 = dword_407090;</span><br><span class="line">  s = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  optval = <span class="number">1</span>;</span><br><span class="line">  sendTimeout = <span class="number">1500</span>;</span><br><span class="line">  portsScanned = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  s = socket(AF_INET, SOCK_RAW, IPPROTO_RAW);</span><br><span class="line">  <span class="keyword">if</span> ( s != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    optval = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( setsockopt(s, IPPROTO_IP, <span class="number">2</span><span class="comment">/*IP_HDRINCL*/</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;optval, <span class="keyword">sizeof</span>(optval)) != <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( setsockopt(s, SOL_SOCKET, SO_SNDTIMEO, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;sendTimeout, <span class="keyword">sizeof</span>(sendTimeout)) != <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        dport = <span class="number">0</span>;</span><br><span class="line">        counter = <span class="number">0</span>;</span><br><span class="line">        hostlong = _startIp;</span><br><span class="line">        <span class="keyword">while</span> ( hostlong &lt;= _endIp )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">          &#123;</span><br><span class="line">            counter = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ( counter &lt; _portsTotal )</span><br><span class="line">            &#123;</span><br><span class="line">              dport = *((DWORD *)_portsArray + counter);</span><br><span class="line"></span><br><span class="line">			  <span class="built_in">memset</span>(&amp;dst, <span class="number">0</span>, <span class="keyword">sizeof</span>(dst));</span><br><span class="line"></span><br><span class="line">              dst.sin_family = AF_INET;</span><br><span class="line">              dst.sin_port = htons(dport);</span><br><span class="line">			  dst.sin_addr.s_addr = htonl(hostlong); </span><br><span class="line"></span><br><span class="line">			  len = buildSynPacket(buf, _bindIpAddr, htons(getrandom(<span class="number">1</span>, <span class="number">65535</span>)), dst.sin_addr.s_addr, dst.sin_port);</span><br><span class="line"></span><br><span class="line">              ++_ipScanned;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> ( sendto(s, buf, len, <span class="number">0</span>, (struct sockaddr *)&amp;dst, <span class="keyword">sizeof</span>(dst)) != <span class="number">-1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                ++portsScanned;</span><br><span class="line">                EnterCriticalSection(&amp;_cs);</span><br><span class="line">                <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;%u Ports Scanned.              \r&quot;</span>, portsScanned);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  v49 = portsScanned / _portsTotal;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;%u IP Scanned.              \r&quot;</span>, portsScanned / _portsTotal);</span><br><span class="line">                &#125;</span><br><span class="line">                LeaveCriticalSection(&amp;_cs);</span><br><span class="line">                <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">                &#123;</span><br><span class="line">                  v15 = hostlong + <span class="number">1</span>;</span><br><span class="line">                  v16 = dport;</span><br><span class="line">                  <span class="keyword">goto</span> __break;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( !(portsScanned % <span class="number">1000</span>) )</span><br><span class="line">                  Sleep(<span class="number">0xA</span>u);</span><br><span class="line">              &#125;</span><br><span class="line">              ++counter;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="comment">// !_isMultiplePort</span></span><br><span class="line">          &#123;</span><br><span class="line">            v49 = v9 - v8 + <span class="number">1</span>;</span><br><span class="line">            counter = v8;</span><br><span class="line">            <span class="keyword">while</span> ( counter &lt;= v9 )</span><br><span class="line">            &#123;</span><br><span class="line">              dport = counter;</span><br><span class="line"></span><br><span class="line">			  <span class="built_in">memset</span>(&amp;dst, <span class="number">0</span>, <span class="keyword">sizeof</span>(dst));</span><br><span class="line">              dst.sin_family = AF_INET;</span><br><span class="line">              dst.sin_port = htons(dport);</span><br><span class="line">			  dst.sin_addr.s_addr = htonl(hostlong); </span><br><span class="line">			  </span><br><span class="line">			  len = buildSynPacket(buf, _bindIpAddr, htons(getrandom(<span class="number">1</span>, <span class="number">65535</span>)), dst.sin_addr.s_addr, dst.sin_port);</span><br><span class="line"></span><br><span class="line">              ++_ipScanned;</span><br><span class="line">              <span class="keyword">if</span> ( sendto(s, buf, len, <span class="number">0</span>, (struct sockaddr *)&amp;dst, <span class="keyword">sizeof</span>(dst)) != <span class="number">-1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                ++portsScanned;</span><br><span class="line">                EnterCriticalSection(&amp;_cs);</span><br><span class="line">                <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;%u Ports Scanned.              \r&quot;</span>, portsScanned);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;%u IP Scanned.              \r&quot;</span>, portsScanned / v49);</span><br><span class="line">                &#125;</span><br><span class="line">                LeaveCriticalSection(&amp;_cs);</span><br><span class="line">                <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">                    v15 = hostlong;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    v15 = hostlong + <span class="number">1</span>;</span><br><span class="line">                  v16 = dport;</span><br><span class="line">                  <span class="keyword">goto</span> __break;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( !(portsScanned % <span class="number">1000</span>) )</span><br><span class="line">                  Sleep(<span class="number">10</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              ++counter;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          ++hostlong;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">__break:</span><br><span class="line">  <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(Dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(Dest));</span><br><span class="line">    wsprintf(Dest, <span class="string">&quot;%d.%d.%d.%d&quot;</span>, v15 &gt;&gt; <span class="number">24</span>, (v15 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (<span class="keyword">unsigned</span> __int16)((WORD)v15 &gt;&gt; <span class="number">8</span>), (<span class="keyword">unsigned</span> __int8)v15);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Last Scan: %s:%d                \n&quot;</span>, Dest, v16);</span><br><span class="line">    <span class="keyword">if</span> ( _isLog )</span><br><span class="line">    &#123;</span><br><span class="line">      wsprintf(Buffer, <span class="string">&quot;LastIP Scanned: %s:%d\r\n&quot;</span>, &amp;Dest, v16);</span><br><span class="line">      logWriteBuffer(_logFile, (<span class="keyword">char</span> *)Buffer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( s != <span class="number">-1</span> )</span><br><span class="line">    closesocket(s);</span><br><span class="line"></span><br><span class="line">  EnterCriticalSection(&amp;_cs);</span><br><span class="line">  <span class="keyword">if</span> ( _threadsUsed )</span><br><span class="line">    --_threadsUsed;</span><br><span class="line">  LeaveCriticalSection(&amp;_cs);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----- (00403FD9) --------------------------------------------------------</span></span><br><span class="line"><span class="function">BOOL <span class="title">buildPortsList</span><span class="params">(<span class="keyword">char</span> * portsList, <span class="keyword">int</span> portsCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL	result; <span class="comment">// eax@4</span></span><br><span class="line">	<span class="keyword">int</span>		port; <span class="comment">// eax@8</span></span><br><span class="line">	<span class="keyword">char</span> *	nextToken; <span class="comment">// eax@5</span></span><br><span class="line">	<span class="keyword">char</span> *	portString; <span class="comment">// [sp+4h] [bp-8h]@5</span></span><br><span class="line"></span><br><span class="line">	_portsArray = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>) * portsCount);</span><br><span class="line"></span><br><span class="line">	result = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( _portsArray )</span><br><span class="line">	&#123;</span><br><span class="line">		nextToken = strtok(portsList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">		portString = nextToken;</span><br><span class="line">		<span class="keyword">if</span> ( nextToken )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">while</span> ( portString )</span><br><span class="line">			&#123;</span><br><span class="line">				port = atoi(portString);</span><br><span class="line">				<span class="keyword">if</span> ( port &gt; <span class="number">0</span> )</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> ( port &lt;= <span class="number">65535</span> )</span><br><span class="line">					&#123;</span><br><span class="line">						*((DWORD *)_portsArray + _portsTotal++) = port;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				portString = strtok(<span class="number">0</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			result = (_portsTotal &gt; <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----- (00403F08) --------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getPortsCount</span><span class="params">(<span class="keyword">char</span> * portList)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>		result; <span class="comment">// eax@4</span></span><br><span class="line">	<span class="keyword">char</span> *	nextToken; <span class="comment">// eax@7</span></span><br><span class="line">	<span class="keyword">char</span> *	buf; <span class="comment">// [sp+4h] [bp-Ch]@5</span></span><br><span class="line">	<span class="keyword">char</span> *	p; <span class="comment">// [sp+Ch] [bp-4h]@7</span></span><br><span class="line">	<span class="keyword">int</span>		count; <span class="comment">// [sp+8h] [bp-8h]@9</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> ( portList )</span><br><span class="line">	&#123;</span><br><span class="line">		buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(lstrlen(portList) + <span class="number">16</span>);</span><br><span class="line">		<span class="keyword">if</span> (buf)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">strcpy</span>(buf, portList);</span><br><span class="line">			nextToken = strtok(buf, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">			p = nextToken;</span><br><span class="line">			<span class="keyword">if</span> (nextToken)</span><br><span class="line">			&#123;</span><br><span class="line">				count = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">while</span> ( p )</span><br><span class="line">				&#123;</span><br><span class="line">					p = strtok(<span class="number">0</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">					count++;</span><br><span class="line">				&#125;</span><br><span class="line">				result = count;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				result = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">free</span>(buf);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			result = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		result = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//----- (00402A70) --------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> __cdecl <span class="title">filterPacket</span><span class="params">(<span class="keyword">char</span> * a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax@4</span></span><br><span class="line">  u_long v3; <span class="comment">// eax@5</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// eax@20</span></span><br><span class="line">  u_short v5; <span class="comment">// ax@20</span></span><br><span class="line">  <span class="keyword">char</span> * v8; <span class="comment">// [sp+144h] [bp-8h]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v9; <span class="comment">// [sp+13Eh] [bp-Eh]@3</span></span><br><span class="line">  <span class="keyword">char</span> * v10; <span class="comment">// [sp+148h] [bp-4h]@3</span></span><br><span class="line">  u_long v11; <span class="comment">// [sp+140h] [bp-Ch]@5</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v12; <span class="comment">// [sp+134h] [bp-18h]@9</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// [sp+138h] [bp-14h]@9</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v14; <span class="comment">// [sp+130h] [bp-1Ch]@10</span></span><br><span class="line">  <span class="keyword">char</span>	buf[<span class="number">0x20</span>]; <span class="comment">// [sp+110h] [bp-3Ch]@20</span></span><br><span class="line">  <span class="keyword">char</span>	logBuffer[<span class="number">0x100</span>];</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v16; <span class="comment">// [sp+10Ch] [bp-40h]@20</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [sp+108h] [bp-44h]@20</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [sp+104h] [bp-48h]@20</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [sp+100h] [bp-4Ch]@20</span></span><br><span class="line"></span><br><span class="line">  v8 = a1;</span><br><span class="line">  v9 = <span class="number">4</span> * (*(BYTE *)a1 &amp; <span class="number">0xF</span>);</span><br><span class="line">  v10 = a1 + v9;</span><br><span class="line">  <span class="keyword">if</span> ( *(BYTE *)(a1 + v9 + <span class="number">13</span>) == <span class="number">20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = ntohl(*(DWORD *)(v8 + <span class="number">12</span>));</span><br><span class="line">    v11 = v3;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt;= _startIp &amp;&amp; v3 &lt;= _endIp )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(BYTE *)(v10 + <span class="number">13</span>) != <span class="number">18</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">      v12 = <span class="number">0</span>;</span><br><span class="line">      v13 = ntohs(*(WORD *)v10);</span><br><span class="line">      <span class="keyword">if</span> ( !_isMultiplePort )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v13 &gt;= _portScanSingle )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v13 &lt;= dword_407090 )</span><br><span class="line">            v12 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v14 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( v14 &lt; _portsTotal )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v13 == *((DWORD *)_portsArray + v14) )</span><br><span class="line">            v12 = <span class="number">1</span>;</span><br><span class="line">          ++v14;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v12 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        v4 = ntohl(*(DWORD *)(v8 + <span class="number">12</span>));</span><br><span class="line">        v14 = v4;</span><br><span class="line">        v16 = v4 &gt;&gt; <span class="number">24</span>;</span><br><span class="line">        v17 = (v4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        v18 = (<span class="keyword">unsigned</span> __int16)((WORD)v4 &gt;&gt; <span class="number">8</span>);</span><br><span class="line">        v19 = (<span class="keyword">unsigned</span> __int8)v4;</span><br><span class="line">        wsprintf(</span><br><span class="line">          buf,</span><br><span class="line">          <span class="string">&quot;%d.%d.%d.%d&quot;</span>,</span><br><span class="line">          v4 &gt;&gt; <span class="number">24</span>,</span><br><span class="line">          (v4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>,</span><br><span class="line">          (<span class="keyword">unsigned</span> __int16)((WORD)v4 &gt;&gt; <span class="number">8</span>),</span><br><span class="line">          (<span class="keyword">unsigned</span> __int8)v4);</span><br><span class="line">        EnterCriticalSection(&amp;_cs);</span><br><span class="line">        ++_totalPortsOpen;</span><br><span class="line">        v5 = ntohs(*(WORD *)v10);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-16s %-5d Open             \n&quot;</span>, buf, v5);</span><br><span class="line">        <span class="keyword">if</span> ( _isLog )</span><br><span class="line">        &#123;</span><br><span class="line">          wsprintf(logBuffer, <span class="string">&quot;%-16s %-5d Open             \r\n&quot;</span>, buf, v5);</span><br><span class="line">          logWriteBuffer(_logFile, logBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">		LeaveCriticalSection(&amp;_cs);</span><br><span class="line">        result = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_26:</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIO_RCVALL _WSAIOW(IOC_VENDOR,1) </span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">snifferThread</span><span class="params">(LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>	ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置SOCK_RAW为SIO_RCVALL，以便接收所有的IP包    </span></span><br><span class="line">	<span class="keyword">int</span> optval = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span>	bytesRet;  </span><br><span class="line">	</span><br><span class="line">	SOCKADDR_IN sa; </span><br><span class="line">	_s = socket(AF_INET, SOCK_RAW, IPPROTO_IP);</span><br><span class="line">	<span class="keyword">if</span> (INVALID_SOCKET == _s)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Fail To Create Socket\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	sa.sin_family = AF_INET;</span><br><span class="line">	sa.sin_port = htons(<span class="number">0</span>);</span><br><span class="line">	sa.sin_addr.S_un.S_addr = _bindIpAddr;</span><br><span class="line">	</span><br><span class="line">	ret = bind(_s, (struct sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));   </span><br><span class="line">	<span class="keyword">if</span> (INVALID_SOCKET == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Fail To Bind Socket\n&quot;</span>);</span><br><span class="line">		closesocket(_s);</span><br><span class="line">		<span class="keyword">goto</span> __faild;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = WSAIoctl(_s, SIO_RCVALL, (LPVOID)&amp;optval, <span class="keyword">sizeof</span>(optval), <span class="literal">NULL</span>, <span class="number">0</span>, (LPDWORD)&amp;bytesRet, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span>	buff[<span class="number">0xFFFF</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">memset</span>(buff, <span class="number">0</span>, <span class="keyword">sizeof</span>(buff));</span><br><span class="line">		ret = recv(_s, buff, <span class="keyword">sizeof</span>(buff), <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">		&#123;</span><br><span class="line">			filterPacket(buff);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (ret &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">__faild:	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">u_long <span class="title">getBindIpAddress</span><span class="params">(<span class="keyword">char</span> * dstIpAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u_long	bindAddr = INADDR_NONE;</span><br><span class="line">	DWORD	nInterfaceIndex = <span class="number">0</span>;</span><br><span class="line">	DWORD	index = <span class="number">0</span>;</span><br><span class="line">	PMIB_IPADDRTABLE	ipTable = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG	allocSize = <span class="number">0</span>;</span><br><span class="line">	HRESULT ret;</span><br><span class="line">	</span><br><span class="line">	ret = GetBestInterface( inet_addr(dstIpAddr), &amp;nInterfaceIndex );</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (ret != NO_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">goto</span> __exit;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	MIB_IFROW ifRow;</span></span><br><span class="line"><span class="comment">	ifRow.dwIndex = nInterfaceIndex;</span></span><br><span class="line"><span class="comment">	ret = GetIfEntry( &amp;ifRow );</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	  if ( ret != NO_ERROR )</span></span><br><span class="line"><span class="comment">	  &#123;</span></span><br><span class="line"><span class="comment">	  goto __exit;</span></span><br><span class="line"><span class="comment">	  &#125;</span></span><br><span class="line"><span class="comment">	  </span></span><br><span class="line"><span class="comment">		printf(&quot;%s\n&quot;, ifRow.bDescr);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	</span><br><span class="line">	allocSize = <span class="number">0</span>;	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		ret = GetIpAddrTable( ipTable, &amp;allocSize, FALSE );</span><br><span class="line">		<span class="keyword">if</span> (ret != NO_ERROR)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (allocSize)</span><br><span class="line">			&#123;</span><br><span class="line">				ipTable = (PMIB_IPADDRTABLE)<span class="built_in">malloc</span>(allocSize);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (ret != NO_ERROR);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; ipTable-&gt;dwNumEntries; index++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (ipTable-&gt;table[ index ].dwIndex == nInterfaceIndex)</span><br><span class="line">		&#123;</span><br><span class="line">			bindAddr = ipTable-&gt;table[ index ].dwAddr;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">__exit:</span><br><span class="line">	<span class="keyword">if</span> (ipTable)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">free</span>(ipTable);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bindAddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildIpRange</span><span class="params">(<span class="keyword">char</span> * startIpAddr, <span class="keyword">char</span> * realStartIpAddr, <span class="keyword">char</span> * realEndIpAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>	startIpStr[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">char</span>	endIpStr[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">char</span> *	slash = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span>		range = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span>		submask = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(startIpStr, <span class="number">0</span>, <span class="keyword">sizeof</span>(startIpStr));</span><br><span class="line">	<span class="built_in">memset</span>(endIpStr, <span class="number">0</span>, <span class="keyword">sizeof</span>(endIpStr));</span><br><span class="line">	</span><br><span class="line">	slash = <span class="built_in">strchr</span>(startIpAddr, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (slash)</span><br><span class="line">	&#123;</span><br><span class="line">		lstrcpyn(startIpStr, startIpAddr, slash - startIpAddr + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">int</span> bit = atoi(slash+<span class="number">1</span>);</span><br><span class="line">		range = <span class="number">0xFFFFFFFF</span> &gt;&gt; bit;</span><br><span class="line">		submask = <span class="number">0xFFFFFFFF</span> &lt;&lt; (<span class="number">32</span> - bit);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		lstrcpy(startIpStr, startIpAddr);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 起始IP参数转化(支持域名)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> * <span class="title">hostInfo</span> = <span class="title">gethostbyname</span>(<span class="title">startIpStr</span>);</span></span><br><span class="line">	<span class="keyword">if</span> (hostInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		lstrcpy(startIpStr, inet_ntoa(*(IN_ADDR*)hostInfo-&gt;h_addr_list[<span class="number">0</span>]));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (submask)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span>	start = (inet_addr(startIpStr) &amp; ntohl(submask)) + ntohl(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">int</span>	end = (inet_addr(startIpStr) &amp; ntohl(submask)) + ntohl(range<span class="number">-1</span>);</span><br><span class="line">		lstrcpy(endIpStr, inet_ntoa(*(IN_ADDR*)&amp;end));</span><br><span class="line">		lstrcpy(startIpStr, inet_ntoa(*(IN_ADDR*)&amp;start));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (realStartIpAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		lstrcpy(realStartIpAddr, startIpStr);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (realEndIpAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		lstrcpy(realEndIpAddr, endIpStr);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startScan</span><span class="params">(<span class="keyword">char</span> * scanType, <span class="keyword">char</span> * startIpAddr, <span class="keyword">char</span> * endIpAddr, <span class="keyword">char</span> * portList, <span class="keyword">char</span> *maxThreads)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>	buf[<span class="number">0x100</span>];</span><br><span class="line">	<span class="keyword">char</span>	lastScan[<span class="number">0x20</span>];</span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">int</span> v5; <span class="comment">// ecx@1</span></span><br><span class="line">	<span class="keyword">unsigned</span> __int32 v8; <span class="comment">// eax@19</span></span><br><span class="line">	<span class="keyword">unsigned</span> __int32 v9; <span class="comment">// eax@19</span></span><br><span class="line">	<span class="keyword">unsigned</span> __int32 startIp; <span class="comment">// eax@23</span></span><br><span class="line">	<span class="keyword">int</span> v11; <span class="comment">// eax@26</span></span><br><span class="line">	<span class="keyword">int</span> v12; <span class="comment">// eax@27</span></span><br><span class="line">	<span class="keyword">int</span> v13; <span class="comment">// eax@35</span></span><br><span class="line">	HANDLE threadSniffer; <span class="comment">// eax@62</span></span><br><span class="line">	HANDLE v17; <span class="comment">// eax@120</span></span><br><span class="line">	<span class="keyword">void</span> *param; <span class="comment">// eax@129</span></span><br><span class="line">	DWORD v20; <span class="comment">// eax@149</span></span><br><span class="line">	<span class="keyword">int</span> v21; <span class="comment">// eax@160</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v22; <span class="comment">// ecx@177</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v23; <span class="comment">// [sp+0h] [bp-27Ch]@2</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">int</span> isSynScan; <span class="comment">// [sp+260h] [bp-1Ch]@3</span></span><br><span class="line">	<span class="keyword">int</span> v25; <span class="comment">// [sp+28h] [bp-254h]@3</span></span><br><span class="line">	<span class="keyword">int</span> v26; <span class="comment">// [sp+26Ch] [bp-10h]@3</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> lastPortScan; <span class="comment">// [sp+268h] [bp-14h]@3</span></span><br><span class="line">	BOOL v29; <span class="comment">// [sp+264h] [bp-18h]@3</span></span><br><span class="line">	<span class="keyword">int</span> count; <span class="comment">// [sp+270h] [bp-Ch]@3</span></span><br><span class="line">	<span class="keyword">int</span> currentIp; <span class="comment">// [sp+14h] [bp-268h]@26</span></span><br><span class="line">	DWORD timeStart; <span class="comment">// [sp+4Ch] [bp-230h]@60</span></span><br><span class="line">	DWORD ThreadId; <span class="comment">// [sp+274h] [bp-8h]@62</span></span><br><span class="line">	HANDLE hObject; <span class="comment">// [sp+278h] [bp-4h]@62</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v37; <span class="comment">// [sp+10h] [bp-26Ch]@116</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> portIndex; <span class="comment">// [sp+Ch] [bp-270h]@118</span></span><br><span class="line">	LPVOID lpParameter; <span class="comment">// [sp+8h] [bp-274h]@119</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v45; <span class="comment">// [sp+25Ch] [bp-20h]@160</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hoursElapsed; <span class="comment">// [sp+58h] [bp-224h]@162</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> minutesElapsed; <span class="comment">// [sp+54h] [bp-228h]@162</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> secondsElapsed; <span class="comment">// [sp+50h] [bp-22Ch]@162</span></span><br><span class="line"></span><br><span class="line">  LONG previousCount;</span><br><span class="line">  <span class="keyword">char</span>	realStartIpAddr[<span class="number">200</span>];</span><br><span class="line">  <span class="keyword">char</span>	realEndIpAddr[<span class="number">200</span>];</span><br><span class="line"></span><br><span class="line">	isSynScan = <span class="number">0</span>;</span><br><span class="line">	v5 = <span class="number">159</span>;</span><br><span class="line">	v25 = <span class="number">0</span>;</span><br><span class="line">	v26 = <span class="number">0</span>;</span><br><span class="line">	lastPortScan = <span class="number">0</span>;</span><br><span class="line">	v29 = <span class="number">0</span>;</span><br><span class="line">	count = <span class="number">0</span>;</span><br><span class="line">	_portsTotal = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !initWinsock() )</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Fail To Init Socket\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">// www.shangdu.com/24 1.1.1.1/16</span></span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	<span class="built_in">memset</span>(realStartIpAddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(realStartIpAddr));</span><br><span class="line">	<span class="built_in">memset</span>(realEndIpAddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(realEndIpAddr));</span><br><span class="line">	<span class="keyword">if</span> (endIpAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		lstrcpy(realEndIpAddr, endIpAddr);</span><br><span class="line">	&#125;</span><br><span class="line">	buildIpRange(startIpAddr, realStartIpAddr, realEndIpAddr);</span><br><span class="line">	startIpAddr = realStartIpAddr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lstrlen(realEndIpAddr) &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		endIpAddr = realEndIpAddr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(lastScan, <span class="number">0</span>, <span class="keyword">sizeof</span>(lastScan));</span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( lstrcmpi(scanType, <span class="string">&quot;SYN&quot;</span>) &amp;&amp; lstrcmpi(scanType, <span class="string">&quot;TCP&quot;</span>) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Invalid Scan Type\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( lstrcmpi(scanType, <span class="string">&quot;SYN&quot;</span>) )</span><br><span class="line">	&#123;</span><br><span class="line">		_maxThreads = atoi(maxThreads);</span><br><span class="line">		<span class="keyword">if</span> ( !_maxThreads || (<span class="keyword">unsigned</span> <span class="keyword">int</span>)_maxThreads &gt; <span class="number">0x400</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Max Thread Out Of Bound\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		isSynScan = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> ( !isWin2K() )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;SYN Scan Can Only Perform On WIN 2K Or Above\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		_maxThreads = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!endIpAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		_isRangeScan = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( !<span class="built_in">strstr</span>(portList, <span class="string">&quot;-&quot;</span>) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ( !<span class="built_in">strstr</span>(portList, <span class="string">&quot;,&quot;</span>) )</span><br><span class="line">			_isSinglePort = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">	&#123;</span><br><span class="line">		startIp = inet_addr(startIpAddr);</span><br><span class="line">		_startIp = ntohl(startIp);</span><br><span class="line">		_endIp = _startIp;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		v8 = inet_addr(startIpAddr);</span><br><span class="line">		_startIp = ntohl(v8);</span><br><span class="line">		v9 = inet_addr(endIpAddr);</span><br><span class="line">		_endIp = ntohl(v9);</span><br><span class="line">		<span class="keyword">if</span> ( _startIp &gt; _endIp )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Invalid Hosts To Scan\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ( _endIp == _startIp )</span><br><span class="line">			_isRangeScan = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!_isSinglePort)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">strstr</span>(portList, <span class="string">&quot;-&quot;</span>) )</span><br><span class="line">		&#123;</span><br><span class="line">			v11 = (<span class="keyword">int</span>)strtok(portList, <span class="string">&quot;-&quot;</span>);</span><br><span class="line">			currentIp = v11;</span><br><span class="line">			<span class="keyword">if</span> ( !v11 )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Something Wrong About The Ports\n&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			_portScanSingle = atoi((<span class="keyword">const</span> <span class="keyword">char</span> *)currentIp);</span><br><span class="line">			v12 = (<span class="keyword">int</span>)strtok(<span class="number">0</span>, <span class="string">&quot;-&quot;</span>);</span><br><span class="line">			currentIp = v12;</span><br><span class="line">			<span class="keyword">if</span> ( v12 )</span><br><span class="line">				dword_407090 = atoi((<span class="keyword">const</span> <span class="keyword">char</span> *)currentIp);</span><br><span class="line">			<span class="keyword">if</span> ( !_portScanSingle || (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_407090 &gt; <span class="number">0xFFFF</span> || _portScanSingle &gt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_407090 )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Invalid Port To Scan\n&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ( !<span class="built_in">strstr</span>(portList, <span class="string">&quot;,&quot;</span>) )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Invalid Port List\n&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			v13 = getPortsCount(portList);</span><br><span class="line">			currentIp = v13;</span><br><span class="line">			<span class="keyword">if</span> ( !v13 )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;No Port To Scan\n&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			_isMultiplePort = buildPortsList(portList, currentIp);</span><br><span class="line">			<span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">			&#123;</span><br><span class="line">				_isSinglePort = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)_portsTotal &lt;= <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _portToScan = atoi(portList);</span><br><span class="line">    <span class="keyword">if</span> ( !_portToScan || _portToScan &gt; <span class="number">0xFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Invalid Port To Scan\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _portScanSingle = _portToScan;</span><br><span class="line">    dword_407090 = _portToScan;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !isSynScan )</span><br><span class="line">    &#123;</span><br><span class="line">      _semaphore = CreateSemaphoreA(<span class="number">0</span>, _maxThreads, _maxThreads, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !_semaphore )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Fail To Create Semaphore\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( _portsArray )</span><br><span class="line">          <span class="built_in">free</span>(_portsArray);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">	_bindIpAddr = getBindIpAddress(startIpAddr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (INADDR_NONE == _bindIpAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">goto</span> __faild;</span><br><span class="line">	&#125;</span><br><span class="line">    timeStart = GetTickCount();</span><br><span class="line">    <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Bind On IP: %d.%d.%d.%d\n\n&quot;</span>, (_bindIpAddr &amp; <span class="number">0x0000ff</span>),</span><br><span class="line">			((_bindIpAddr &amp; <span class="number">0x00ff00</span>) &gt;&gt; <span class="number">8</span>), ((_bindIpAddr &amp; <span class="number">0xff0000</span> ) &gt;&gt; <span class="number">16</span>),	(_bindIpAddr &gt;&gt; <span class="number">24</span>));</span><br><span class="line"></span><br><span class="line">		threadSniffer = CreateThread(<span class="number">0</span>, <span class="number">0</span>, snifferThread, <span class="number">0</span>, <span class="number">0</span>, &amp;ThreadId);</span><br><span class="line">		hObject = threadSniffer;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> == threadSniffer)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">goto</span> __faild;</span><br><span class="line">		&#125;</span><br><span class="line">      CloseHandle(hObject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( _isLog )</span><br><span class="line">    &#123;</span><br><span class="line">      logWriteBuffer(_logFile, <span class="string">&quot;-------------------------------------------------------------------------------\r\n&quot;</span>);</span><br><span class="line">      logWriteTime(_logFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( _isRangeScan || _isSinglePort )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (!_isRangeScan) &amp; _isSinglePort )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;SYN Scan: About To Scan %u IP Using %d Thread\n&quot;</span>, _endIp - _startIp + <span class="number">1</span>, _maxThreads);</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            wsprintf(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;SYN Scan: About To Scan %u IP Using %d Thread\r\n&quot;</span>,</span><br><span class="line">              _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">              _maxThreads);</span><br><span class="line">            logWriteBuffer(_logFile, buf);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Normal Scan: About To Scan %u IP Using %d Threads\n&quot;</span>, _endIp - _startIp + <span class="number">1</span>, _maxThreads);</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            wsprintf(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;Normal Scan: About To Scan %u IP Using %d Threads\r\n&quot;</span>,</span><br><span class="line">              _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">              _maxThreads);</span><br><span class="line">            logWriteBuffer(_logFile, buf);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (!_isRangeScan || _isSinglePort) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( _isSinglePort )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;SYN Scan: About To Scan %s:%d Using %d Thread\n&quot;</span>, startIpAddr, *(DWORD *)_portsArray, _maxThreads);</span><br><span class="line">                  <span class="keyword">if</span> ( _isLog )</span><br><span class="line">                  &#123;</span><br><span class="line">                    wsprintf(</span><br><span class="line">                      buf,</span><br><span class="line">                      <span class="string">&quot;SYN Scan: About To Scan %s:%d Using %d Thread\r\n&quot;</span>,</span><br><span class="line">                      startIpAddr,</span><br><span class="line">                      *(DWORD *)_portsArray,</span><br><span class="line">                      _maxThreads);</span><br><span class="line">                    logWriteBuffer(_logFile, buf);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;SYN Scan: About To Scan %s:%d Using %d Thread\n&quot;</span>, startIpAddr, _portScanSingle, _maxThreads);</span><br><span class="line">                  <span class="keyword">if</span> ( _isLog )</span><br><span class="line">                  &#123;</span><br><span class="line">                    wsprintf(</span><br><span class="line">                      buf,</span><br><span class="line">                      <span class="string">&quot;SYN Scan: About To Scan %s:%d Using %d Thread\r\n&quot;</span>,</span><br><span class="line">                      startIpAddr,</span><br><span class="line">                      _portScanSingle,</span><br><span class="line">                      _maxThreads);</span><br><span class="line">                    logWriteBuffer(_logFile, buf);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;Normal Scan: About To Scan %s:%d Using %d Thread\n&quot;</span>, startIpAddr, *(DWORD *)_portsArray, _maxThreads);</span><br><span class="line">                  <span class="keyword">if</span> ( _isLog )</span><br><span class="line">                  &#123;</span><br><span class="line">                    wsprintf(</span><br><span class="line">                      buf,</span><br><span class="line">                      <span class="string">&quot;Normal Scan: About To Scan %s:%d Using %d Thread\r\n&quot;</span>,</span><br><span class="line">                      startIpAddr,</span><br><span class="line">                      *(DWORD *)_portsArray,</span><br><span class="line">                      _maxThreads);</span><br><span class="line">                    logWriteBuffer(_logFile, buf);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;Normal Scan: About To Scan %s:%d Using %d Thread\n&quot;</span>, startIpAddr, _portScanSingle, _maxThreads);</span><br><span class="line">                  <span class="keyword">if</span> ( _isLog )</span><br><span class="line">                  &#123;</span><br><span class="line">                    wsprintf(</span><br><span class="line">                      buf,</span><br><span class="line">                      <span class="string">&quot;Normal Scan: About To Scan %s:%d Using %d Thread\r\n&quot;</span>,</span><br><span class="line">                      startIpAddr,</span><br><span class="line">                      _portScanSingle,</span><br><span class="line">                      _maxThreads);</span><br><span class="line">                    logWriteBuffer(_logFile, buf);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;SYN Scan: About To Scan %u Ports Using %d Thread\n&quot;</span>, _portsTotal, _maxThreads);</span><br><span class="line">              <span class="keyword">if</span> ( _isLog )</span><br><span class="line">              &#123;</span><br><span class="line">                wsprintf(buf, <span class="string">&quot;SYN Scan: About To Scan %u Ports Using %d Thread\r\n&quot;</span>, _portsTotal, _maxThreads);</span><br><span class="line">                logWriteBuffer(_logFile, buf);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(</span><br><span class="line">                <span class="string">&quot;SYN Scan: About To Scan %u Ports Using %d Thread\n&quot;</span>,</span><br><span class="line">                dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">                _maxThreads);</span><br><span class="line">              <span class="keyword">if</span> ( _isLog )</span><br><span class="line">              &#123;</span><br><span class="line">                wsprintf(</span><br><span class="line">                  buf,</span><br><span class="line">                  <span class="string">&quot;SYN Scan: About To Scan %u Ports Using %d Thread\r\n&quot;</span>,</span><br><span class="line">                  dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">                  _maxThreads);</span><br><span class="line">                logWriteBuffer(_logFile, buf);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;Normal Scan: About To Scan %u Ports Using %d Thread\n&quot;</span>, _portsTotal, _maxThreads);</span><br><span class="line">              <span class="keyword">if</span> ( _isLog )</span><br><span class="line">              &#123;</span><br><span class="line">                wsprintf(buf, <span class="string">&quot;Normal Scan: About To Scan %u Ports Using %d Thread\r\n&quot;</span>, _portsTotal, _maxThreads);</span><br><span class="line">                logWriteBuffer(_logFile, buf);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(</span><br><span class="line">                <span class="string">&quot;Normal Scan: About To Scan %u Ports Using %d Thread\n&quot;</span>,</span><br><span class="line">                dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">                _maxThreads);</span><br><span class="line">              <span class="keyword">if</span> ( _isLog )</span><br><span class="line">              &#123;</span><br><span class="line">                wsprintf(</span><br><span class="line">                  buf,</span><br><span class="line">                  <span class="string">&quot;Normal Scan: About To Scan %u Ports Using %d Thread\r\n&quot;</span>,</span><br><span class="line">                  dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">                  _maxThreads);</span><br><span class="line">                logWriteBuffer(_logFile, buf);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;SYN Scan: About To Scan %u IP For %u Ports Using %d Thread\n&quot;</span>,</span><br><span class="line">            _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">            _portsTotal,</span><br><span class="line">            _maxThreads);</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            wsprintf(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;SYN Scan: About To Scan %u IP For %u Ports Using %d Thread\r\n&quot;</span>,</span><br><span class="line">              _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">              _portsTotal,</span><br><span class="line">              _maxThreads);</span><br><span class="line">            logWriteBuffer(_logFile, buf);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;SYN Scan: About To Scan %u IP For %u Ports Using %d Thread\n&quot;</span>,</span><br><span class="line">            _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">            dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">            _maxThreads);</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            wsprintf(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;SYN Scan: About To Scan %u IP For %u Ports Using %d Thread\r\n&quot;</span>,</span><br><span class="line">              _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">              dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">              _maxThreads);</span><br><span class="line">            logWriteBuffer(_logFile, buf);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;Normal Scan: About To Scan %u IP For %u Ports Using %d Thread\n&quot;</span>,</span><br><span class="line">            _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">            _portsTotal,</span><br><span class="line">            _maxThreads);</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            wsprintf(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;Normal Scan: About To Scan %u IP For %u Ports Using %d Thread\r\n&quot;</span>,</span><br><span class="line">              _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">              _portsTotal,</span><br><span class="line">              _maxThreads);</span><br><span class="line">            logWriteBuffer(_logFile, buf);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;Normal Scan: About To Scan %u IP For %u Ports Using %d Thread\n&quot;</span>,</span><br><span class="line">            _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">            dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">            _maxThreads);</span><br><span class="line">          <span class="keyword">if</span> ( _isLog )</span><br><span class="line">          &#123;</span><br><span class="line">            wsprintf(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;Normal Scan: About To Scan %u IP For %u Ports Using %d Thread\r\n&quot;</span>,</span><br><span class="line">              _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">              dword_407090 - _portScanSingle + <span class="number">1</span>,</span><br><span class="line">              _maxThreads);</span><br><span class="line">            logWriteBuffer(_logFile, buf);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">    &#123;</span><br><span class="line">      ++_threadsUsed;</span><br><span class="line">      synScan();</span><br><span class="line">      <span class="keyword">goto</span> LABEL_147;</span><br><span class="line">    &#125;</span><br><span class="line">    v37 = <span class="number">0</span>;</span><br><span class="line">    currentIp = _startIp;</span><br><span class="line">    <span class="keyword">while</span> ( currentIp &lt;= _endIp )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">      &#123;</span><br><span class="line">        portIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( portIndex &lt; _portsTotal )</span><br><span class="line">        &#123;</span><br><span class="line">          lpParameter = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(DWORD) * <span class="number">2</span>);</span><br><span class="line">          <span class="keyword">if</span> ( lpParameter )</span><br><span class="line">          &#123;</span><br><span class="line">            *(DWORD *)lpParameter = currentIp;</span><br><span class="line">            *((DWORD *)lpParameter + <span class="number">1</span>) = *((DWORD *)_portsArray + portIndex);</span><br><span class="line"></span><br><span class="line">            v17 = CreateThread(<span class="number">0</span>, <span class="number">0</span>, tcpScanThread, lpParameter, <span class="number">0</span>, &amp;ThreadId);</span><br><span class="line">            hObject = v17;</span><br><span class="line">            <span class="keyword">if</span> ( v17 )</span><br><span class="line">            &#123;</span><br><span class="line">              EnterCriticalSection(&amp;_cs);</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;%u IP Scanned.Taking %d Threads \r&quot;</span>, _ipScanned / (<span class="keyword">unsigned</span> <span class="keyword">int</span>)_portsTotal, _threadsUsed++);</span><br><span class="line">              ++count;</span><br><span class="line">              LeaveCriticalSection(&amp;_cs);</span><br><span class="line">              CloseHandle(hObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">            &#123;</span><br><span class="line">              v26 = currentIp + <span class="number">1</span>;</span><br><span class="line">              lastPortScan = *((DWORD *)_portsArray + portIndex);</span><br><span class="line">              v37 = <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            WaitForSingleObject(_semaphore, INFINITE);</span><br><span class="line">          &#125;</span><br><span class="line">          ++portIndex;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        lpParameter = (LPVOID)(dword_407090 - _portScanSingle + <span class="number">1</span>);</span><br><span class="line">        portIndex = _portScanSingle;</span><br><span class="line">        <span class="keyword">while</span> ( portIndex &lt;= dword_407090 )</span><br><span class="line">        &#123;</span><br><span class="line">          param = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(DWORD) * <span class="number">2</span>);</span><br><span class="line">          <span class="keyword">if</span> ( param )</span><br><span class="line">          &#123;</span><br><span class="line">            *(DWORD *)param = currentIp;</span><br><span class="line">			*((DWORD *)param + <span class="number">1</span>) = portIndex;</span><br><span class="line">            hObject = CreateThread(<span class="number">0</span>, <span class="number">0</span>, tcpScanThread, (LPVOID)param, <span class="number">0</span>, &amp;ThreadId);</span><br><span class="line">            <span class="keyword">if</span> ( hObject )</span><br><span class="line">            &#123;</span><br><span class="line">              EnterCriticalSection(&amp;_cs);</span><br><span class="line">              <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( !_isSinglePort )</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;%u Ports Scanned.Taking %d Threads \r&quot;</span>, _ipScanned, _threadsUsed);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                v23 = _ipScanned / (<span class="keyword">unsigned</span> <span class="keyword">int</span>)lpParameter;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%u IP Scanned.Taking %d Threads \r&quot;</span>, _ipScanned / (<span class="keyword">unsigned</span> <span class="keyword">int</span>)lpParameter, _threadsUsed);</span><br><span class="line">              &#125;</span><br><span class="line">              ++_threadsUsed;</span><br><span class="line">              ++count;</span><br><span class="line">              LeaveCriticalSection(&amp;_cs);</span><br><span class="line">              CloseHandle(hObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">                v26 = currentIp;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                v26 = currentIp + <span class="number">1</span>;</span><br><span class="line">              lastPortScan = portIndex;</span><br><span class="line">              v37 = <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            WaitForSingleObject(_semaphore, INFINITE);</span><br><span class="line">          &#125;</span><br><span class="line">          ++portIndex;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v37 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++currentIp;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_147:</span><br><span class="line">    <span class="keyword">while</span> ( _threadsUsed )</span><br><span class="line">    &#123;</span><br><span class="line">      WaitForSingleObject(_semaphore, INFINITE);</span><br><span class="line">      EnterCriticalSection(&amp;_cs);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d Threads Are In Process......              \r&quot;</span>, _threadsUsed);</span><br><span class="line">      v29 = ReleaseSemaphore(_semaphore, <span class="number">1</span>, &amp;previousCount);</span><br><span class="line">      LeaveCriticalSection(&amp;_cs);</span><br><span class="line">      <span class="keyword">if</span> ( !v29 )</span><br><span class="line">      &#123;</span><br><span class="line">        v20 = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error Code: %d\n&quot;</span>, v20);</span><br><span class="line">        Sleep(<span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( previousCount + <span class="number">1</span> != _maxThreads )</span><br><span class="line">      &#123;</span><br><span class="line">        Sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> ( _ipScanned != count )</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( isSynScan )</span><br><span class="line">      Sleep(<span class="number">500</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !isSynScan )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">      &#123;</span><br><span class="line">        wsprintf(</span><br><span class="line">          lastScan,</span><br><span class="line">          <span class="string">&quot;%d.%d.%d.%d&quot;</span>,</span><br><span class="line">          (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v26 &gt;&gt; <span class="number">24</span>,</span><br><span class="line">          ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)v26 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>,</span><br><span class="line">          (<span class="keyword">unsigned</span> __int16)((WORD)v26 &gt;&gt; <span class="number">8</span>),</span><br><span class="line">          (<span class="keyword">unsigned</span> __int8)v26);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Last Scan: %s:%d                \n&quot;</span>, &amp;lastScan, lastPortScan);</span><br><span class="line">        <span class="keyword">if</span> ( _isLog )</span><br><span class="line">        &#123;</span><br><span class="line">          wsprintf(buf, <span class="string">&quot;LastIP Scanned: %s:%d\r\n&quot;</span>, &amp;lastScan, lastPortScan);</span><br><span class="line">          logWriteBuffer(_logFile, buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v21 = (GetTickCount() - timeStart) / <span class="number">0x3E8</span>;</span><br><span class="line">    currentIp = v21;</span><br><span class="line">    v45 = v21;</span><br><span class="line">    <span class="keyword">if</span> ( !v21 )</span><br><span class="line">      ++v45;</span><br><span class="line">    v37 = v45 % <span class="number">0x15180</span> / <span class="number">0xE10</span>;</span><br><span class="line">    hoursElapsed = v45 % <span class="number">0x15180</span> / <span class="number">0xE10</span>;</span><br><span class="line">    portIndex = v45 % <span class="number">0x15180</span> % <span class="number">0xE10</span> / <span class="number">0x3C</span>;</span><br><span class="line">    minutesElapsed = v45 % <span class="number">0x15180</span> % <span class="number">0xE10</span> / <span class="number">0x3C</span>;</span><br><span class="line">    secondsElapsed = v45 % <span class="number">0x15180</span> % <span class="number">0xE10</span> % <span class="number">0x3C</span>;</span><br><span class="line">    <span class="keyword">if</span> ( _isBreak )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Scan %s Complete In %d Hours %d Minutes %d Seconds. Found %u Open Ports\n&quot;</span>,</span><br><span class="line">          startIpAddr,</span><br><span class="line">          hoursElapsed,</span><br><span class="line">          minutesElapsed,</span><br><span class="line">          secondsElapsed,</span><br><span class="line">          _totalPortsOpen);</span><br><span class="line">        <span class="keyword">if</span> ( _isLog )</span><br><span class="line">        &#123;</span><br><span class="line">          wsprintf(</span><br><span class="line">            buf,</span><br><span class="line">            <span class="string">&quot;Scan %s Complete In %d Hours %d Minutes %d Seconds. Found %u Open Ports\r\n&quot;</span>,</span><br><span class="line">            startIpAddr,</span><br><span class="line">            hoursElapsed,</span><br><span class="line">            minutesElapsed,</span><br><span class="line">            secondsElapsed,</span><br><span class="line">            _totalPortsOpen);</span><br><span class="line">          logWriteBuffer(_logFile, buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( _isSinglePort )</span><br><span class="line">        &#123;</span><br><span class="line">          lpParameter = (LPVOID)_ipScanned;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( _isMultiplePort )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( _portsTotal )</span><br><span class="line">            &#123;</span><br><span class="line">              lpParameter = (LPVOID)(_ipScanned / (<span class="keyword">unsigned</span> <span class="keyword">int</span>)_portsTotal);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              lpParameter = (LPVOID)_ipScanned;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v22 = dword_407090 - _portScanSingle + <span class="number">1</span>;</span><br><span class="line">            lpParameter = (LPVOID)(_ipScanned / v22);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Scan %u IPs Complete In %d Hours %d Minutes %d Seconds. Found %u Hosts\n&quot;</span>,</span><br><span class="line">          lpParameter,</span><br><span class="line">          hoursElapsed,</span><br><span class="line">          minutesElapsed,</span><br><span class="line">          secondsElapsed,</span><br><span class="line">          _totalPortsOpen);</span><br><span class="line">        <span class="keyword">if</span> ( _isLog )</span><br><span class="line">        &#123;</span><br><span class="line">          wsprintf(</span><br><span class="line">            buf,</span><br><span class="line">            <span class="string">&quot;Scan %u IPs Complete In %d Hours %d Minutes %d Seconds. Found %u Hosts\r\n&quot;</span>,</span><br><span class="line">            lpParameter,</span><br><span class="line">            hoursElapsed,</span><br><span class="line">            minutesElapsed,</span><br><span class="line">            secondsElapsed,</span><br><span class="line">            _totalPortsOpen);</span><br><span class="line">          logWriteBuffer(_logFile, buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( _isRangeScan )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Scan %s Complete In %d Hours %d Minutes %d Seconds. Found %u Open Ports\n&quot;</span>,</span><br><span class="line">          startIpAddr,</span><br><span class="line">          hoursElapsed,</span><br><span class="line">          minutesElapsed,</span><br><span class="line">          secondsElapsed,</span><br><span class="line">          _totalPortsOpen);</span><br><span class="line">        <span class="keyword">if</span> ( _isLog )</span><br><span class="line">        &#123;</span><br><span class="line">          wsprintf(</span><br><span class="line">            buf,</span><br><span class="line">            <span class="string">&quot;Scan %s Complete In %d Hours %d Minutes %d Seconds. Found %u Open Ports\r\n&quot;</span>,</span><br><span class="line">            startIpAddr,</span><br><span class="line">            hoursElapsed,</span><br><span class="line">            minutesElapsed,</span><br><span class="line">            secondsElapsed,</span><br><span class="line">            _totalPortsOpen);</span><br><span class="line">          logWriteBuffer(_logFile, buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Scan %u IPs Complete In %d Hours %d Minutes %d Seconds. Found %u Hosts\r\n&quot;</span>,</span><br><span class="line">          _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">          hoursElapsed,</span><br><span class="line">          minutesElapsed,</span><br><span class="line">          secondsElapsed,</span><br><span class="line">          _totalPortsOpen);</span><br><span class="line">        <span class="keyword">if</span> ( _isLog )</span><br><span class="line">        &#123;</span><br><span class="line">          wsprintf(</span><br><span class="line">            buf,</span><br><span class="line">            <span class="string">&quot;Scan %u IPs Complete In %d Hours %d Minutes %d Seconds. Found %u Hosts\r\n&quot;</span>,</span><br><span class="line">            _endIp - _startIp + <span class="number">1</span>,</span><br><span class="line">            hoursElapsed,</span><br><span class="line">            minutesElapsed,</span><br><span class="line">            secondsElapsed,</span><br><span class="line">            _totalPortsOpen);</span><br><span class="line">          logWriteBuffer(_logFile, buf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( _isLog )</span><br><span class="line">      logWriteBuffer(_logFile, <span class="string">&quot;-------------------------------------------------------------------------------\r\n\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">__faild:</span><br><span class="line">  <span class="keyword">if</span> ( _semaphore )</span><br><span class="line">	  CloseHandle(_semaphore);</span><br><span class="line">  <span class="keyword">if</span> ( _s != <span class="number">-1</span> )</span><br><span class="line">	  closesocket(_s);</span><br><span class="line">  <span class="keyword">if</span> ( _portsArray )</span><br><span class="line">	  <span class="built_in">free</span>(_portsArray);</span><br><span class="line">  WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>	ret;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;TCP Port Scanner V1.2 By WinEggDrop\n\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> ( argc == <span class="number">4</span> || argc == <span class="number">5</span> || argc == <span class="number">6</span> || argc == <span class="number">7</span> || argc == <span class="number">8</span> || argc == <span class="number">9</span> )</span><br><span class="line">	&#123;</span><br><span class="line">	 <span class="keyword">if</span> ( SetConsoleCtrlHandler(ConsoleCtrlHandler, TRUE) )</span><br><span class="line">	 &#123;</span><br><span class="line">		 <span class="keyword">if</span> ( InitializeCriticalSectionAndSpinCount(&amp;_cs, <span class="number">0x80000400</span>) )</span><br><span class="line">		 &#123;</span><br><span class="line">			 <span class="keyword">int</span> arg = argc;</span><br><span class="line">			 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++)</span><br><span class="line">			 &#123;</span><br><span class="line">				<span class="keyword">if</span> (!lstrcmpi(argv[argc - i], <span class="string">&quot;/Save&quot;</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					_isLog = TRUE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!lstrcmpi(argv[argc - i], <span class="string">&quot;/Banner&quot;</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					_isBanner = TRUE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!lstrcmpi(argv[argc - i], <span class="string">&quot;/HBanner&quot;</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					_isBanner = TRUE;</span><br><span class="line">					_isHttp = TRUE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!_strnicmp(argv[argc - i], <span class="string">&quot;/T&quot;</span>, <span class="number">2</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					_tcpTimeout = atoi(argv[argc - i]+<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (!_tcpTimeout)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">printf</span>(<span class="string">&quot;Invalid timeout value\n&quot;</span>);</span><br><span class="line">						<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				arg--;</span><br><span class="line">			 &#125;</span><br><span class="line">			 </span><br><span class="line">			 <span class="keyword">switch</span> ( arg )</span><br><span class="line">			 &#123;</span><br><span class="line">			 <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				 startScan(argv[<span class="number">1</span>], argv[<span class="number">2</span>], <span class="number">0</span>, argv[<span class="number">3</span>], <span class="string">&quot;1&quot;</span>);</span><br><span class="line">				 <span class="keyword">break</span>;</span><br><span class="line">			 <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">				 <span class="keyword">if</span> ( lstrcmpi(argv[<span class="number">1</span>], <span class="string">&quot;SYN&quot;</span>) )</span><br><span class="line">					 startScan(argv[<span class="number">1</span>], argv[<span class="number">2</span>], <span class="number">0</span>, argv[<span class="number">3</span>], argv[<span class="number">4</span>]);</span><br><span class="line">				 <span class="keyword">else</span></span><br><span class="line">					 startScan(argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>], argv[<span class="number">4</span>], <span class="string">&quot;1&quot;</span>);</span><br><span class="line">				 <span class="keyword">break</span>;</span><br><span class="line">			 <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">				 startScan(argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>], argv[<span class="number">4</span>], argv[<span class="number">5</span>]);</span><br><span class="line">				 <span class="keyword">break</span>;</span><br><span class="line">			 &#125;</span><br><span class="line">			 DeleteCriticalSection(&amp;_cs);</span><br><span class="line">			 ret = <span class="number">0</span>;</span><br><span class="line">		 &#125;</span><br><span class="line">		 <span class="keyword">else</span></span><br><span class="line">		 &#123;</span><br><span class="line">			 ret = <span class="number">-1</span>;</span><br><span class="line">		 &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">	 <span class="keyword">else</span></span><br><span class="line">	 &#123;</span><br><span class="line">		 <span class="built_in">printf</span>(<span class="string">&quot;Could Not Set Up Control Handler\n&quot;</span>);</span><br><span class="line">		 ret = <span class="number">-1</span>;</span><br><span class="line">	 &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">	 help(argv[<span class="number">0</span>]);</span><br><span class="line">	 ret = <span class="number">-1</span>;</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-10-07</span><i class="fa fa-tag"></i><a class="tag" href="/tags/c/" title="c">c </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninecmd.com/2020/10/07/S扫描器源码/,NINE的博客,S扫描器源码,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/10/07/Field-%E2%80%98id%E2%80%99-doesn%E2%80%99t-have-a-default-value%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" title="Field ‘id’ doesn’t have a default value问题解决方法">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/10/07/THE-SUCCESS-INDICATOR/" title="THE SUCCESS INDICATOR">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'',
  app_key:'',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'mp'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":200,"height":400,"hOffset":5,"vOffset":-38},"mobile":{"show":false,"scale":0.2},"react":{"opacityDefault":0.8,"opacityOnHover":0.2},"log":false});</script></body></html>